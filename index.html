<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda Digital IA</title>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #111827; /* Fijo: bg-gray-900 */
      color: #f3f4f6; /* Fijo: text-gray-100 */
    }
    /* Estilos para el scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #1f2937; /* bg-gray-800 */
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: #4b5563; /* bg-gray-600 */
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #6b7280; /* bg-gray-500 */
    }
    /* Clases para el toast (Notificaciones) */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 1000;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    .toast.success { background-color: #10B981; color: white; }
    .toast.error { background-color: #EF4444; color: white; }
    .toast.info { background-color: #3B82F6; color: white; }

    /* Estilos para la Agenda de Hoy (Timeline) */
    .timeline-item {
      position: relative;
      padding-left: 2.5rem; /* 40px */
      padding-bottom: 1.5rem; /* 24px */
      border-left: 2px solid #374151; /* border-gray-700 */
    }
    .timeline-item:last-child {
      border-left-color: transparent;
      padding-bottom: 0;
    }
    .timeline-dot {
      position: absolute;
      left: -9px; /* Centra el círculo en la línea */
      top: 1px;
      width: 18px;
      height: 18px;
      border-radius: 9999px;
      border-width: 4px;
      border-color: #1f2937; /* bg-gray-800 */
      background-color: #3b82f6; /* bg-blue-500 */
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef, createContext, useContext } = React;

    // --- Clave de API de Gemini ---
    const GEMINI_API_KEY = ""; 
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

    // --- Funciones de API de IA ---

    // Función de backoff exponencial para reintentos de API
    const exponentialBackoff = (fn, retries = 5, delay = 1000) => {
      return new Promise((resolve, reject) => {
        const attempt = async (tryCount) => {
          try {
            const result = await fn();
            resolve(result);
          } catch (error) {
            if (tryCount <= retries) {
              // No registrar en consola los reintentos
              setTimeout(() => attempt(tryCount + 1), delay * Math.pow(2, tryCount - 1));
            } else {
              reject(error);
            }
          }
        };
        attempt(1);
      });
    };

    // Función genérica para llamar a Gemini con un esquema
    const callGemini = async (prompt, responseSchema, systemPrompt) => {
      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: {
          responseMimeType: "application/json",
          responseSchema: responseSchema,
        },
        systemInstruction: {
          parts: [{ text: systemPrompt }]
        },
      };

      const fetchFn = async () => {
        const response = await fetch(GEMINI_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        
        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
          const jsonText = result.candidates[0].content.parts[0].text;
          return JSON.parse(jsonText);
        } else {
          throw new Error("Respuesta de IA inválida o vacía.");
        }
      };

      return exponentialBackoff(fetchFn);
    };

    // --- Función de ID simple ---
    const generateId = () => {
      return '_' + Math.random().toString(36).substr(2, 9);
    };

    // --- Colores predefinidos para Proyectos ---
    const PROJECT_COLORS = [
      '#60a5fa', // blue-400
      '#f87171', // red-400
      '#4ade80', // green-400
      '#facc15', // yellow-400
      '#c084fc', // purple-400
      '#fb923c', // orange-400
    ];

    // --- Utilidad para contraste de color ---
    const getContrastColor = (hexcolor) => {
      if (!hexcolor) return '#FFFFFF'; // Default to white text
      hexcolor = hexcolor.replace('#', '');
      if (hexcolor.length === 3) {
        hexcolor = hexcolor.split('').map(hex => hex + hex).join('');
      }
      const r = parseInt(hexcolor.substr(0, 2), 16);
      const g = parseInt(hexcolor.substr(2, 2), 16);
      const b = parseInt(hexcolor.substr(4, 2), 16);
      const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
      // Retorna negro si el fondo es claro, blanco si es oscuro
      return (yiq >= 128) ? '#000000' : '#FFFFFF';
    };


    // --- Iconos (Componentes SVG) ---
    const CalendarIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    );
    const ProjectIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
      </svg>
    );
    const DashboardIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
      </svg>
    );
    const PlusIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
      </svg>
    );
    const TrashIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    );
    const EditIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
    );
    const ClockIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );
    const FolderIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
      </svg>
    );
    const NoteIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
    );
    const TimerIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );
    const PlayIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
        <path strokeLinecap="round" strokeLinejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );
    const PauseIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );
    const RefreshIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2.082a9.002 9.002 0 00-16.134 0M19.644 12A9 9 0 113.866 12.001" />
      </svg>
    );
    const StudyIcon = () => ( // Corregido
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.253v11.494M12 6.253c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z" />
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.253v11.494m-5.468-9.088c-1.332.61-2.28 1.9-2.28 3.333 0 1.933 1.567 3.5 3.5 3.5s3.5-1.567 3.5-3.5c0-1.433-.948-2.722-2.28-3.333M21.75 12c0 1.933-1.567 3.5-3.5 3.5s-3.5-1.567-3.5-3.5c0-1.433.948-2.722 2.28-3.333M3 12c0 1.933 1.567 3.5 3.5 3.5s3.5-1.567 3.5-3.5c0-1.433-.948-2.722-2.28-3.333" />
      </svg>
    );
    const SparklesIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m1-9l2-2 2 2m-2-2v4m2 10l2 2 2-2m-2 2v-4m-6 4l-2 2-2-2m2 2v-4m6-4l2-2 2 2m-2-2v4" />
      </svg>
    );
    const TimelineIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
    );
    const ChartBarIcon = () => ( // Corregido (usando otro ícono)
       <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h16a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    );


    // --- Hook Personalizado: useLocalStorage ---
    const useLocalStorage = (key, initialValue) => {
      const [storedValue, setStoredValue] = useState(() => {
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch (error) {
          console.error(error);
          return initialValue;
        }
      });

      const setValue = (value) => {
        try {
          const valueToStore = value instanceof Function ? value(storedValue) : value;
          setStoredValue(valueToStore);
          window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) {
          console.error(error);
        }
      };
      return [storedValue, setValue];
    };

    // --- Funciones de Utilidad de Fecha ---
    const getTodayISO = () => {
      const today = new Date();
      return today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
    };

    // (NUEVO) Helper para obtener la fecha de mañana
    const getTomorrowISO = () => {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      return tomorrow.getFullYear() + '-' + String(tomorrow.getMonth() + 1).padStart(2, '0') + '-' + String(tomorrow.getDate()).padStart(2, '0');
    };

    const formatDate = (isoDate) => {
      if (!isoDate) return '';
      try {
        const date = new Date(isoDate + 'T00:00:00'); // Asumir zona horaria local
        return date.toLocaleDateString('es-ES', { weekday: 'long', month: 'long', day: 'numeric' });
      } catch(e) {
        return "Fecha inválida";
      }
    };
    
    // --- Contexto y Hook para Notificaciones (Toast) ---
    const ToastContext = createContext();

    const ToastProvider = ({ children }) => {
      const [toast, setToast] = useState(null);

      const showToast = (message, type = 'info') => {
        setToast({ message, type });
        setTimeout(() => {
          setToast(null);
        }, 3000);
      };

      return (
        <ToastContext.Provider value={showToast}>
          {children}
          {toast && (
            <div className={`toast show ${toast.type}`}>
              {toast.message}
            </div>
          )}
        </ToastContext.Provider>
      );
    };

    const useToast = () => {
      return useContext(ToastContext);
    };

    // --- Componente Modal ---
    const Modal = ({ isOpen, onClose, children }) => {
      if (!isOpen) return null;

      return (
        <div 
          className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 p-4"
          onClick={onClose}
        >
          <div 
            className="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto"
            onClick={(e) => e.stopPropagation()}
          >
            {children}
          </div>
        </div>
      );
    };

    // --- Componente TaskItem ---
    const TaskItem = ({ task, onToggleComplete, onEdit, onDelete, onStartTimer, projects }) => {
      const project = useMemo(() => projects.find(p => p.id === task.projectId), [projects, task.projectId]);
      const isCompleted = task.status === 'completed';

      return (
        <div 
          className={`relative flex flex-col sm:flex-row sm:items-center justify-between p-4 bg-gray-800 rounded-lg shadow mb-3 transition-all duration-200 ${isCompleted ? 'opacity-50' : ''} border-l-4 ${isCompleted ? 'border-green-600' : 'border-gray-700'}`}
        >
          <div className="flex items-start w-full">
            <input
              type="checkbox"
              checked={isCompleted}
              onChange={() => onToggleComplete(task.id)}
              className="form-checkbox h-5 w-5 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 mt-1 flex-shrink-0"
            />
            <div className="ml-4 flex-grow min-w-0">
              <p className={`text-lg font-medium text-white ${isCompleted ? 'line-through' : ''}`}>
                {task.text}
              </p>
              <div className="flex flex-wrap items-center text-sm text-gray-400 mt-1 gap-x-4 gap-y-1">
                {task.date && (
                  <span className="flex items-center">
                    <CalendarIcon /> {formatDate(task.date)}
                  </span>
                )}
                {task.time && (
                  <span className="flex items-center">
                    <ClockIcon /> {task.time}
                  </span>
                )}
                {project && (
                  <span 
                    className="flex items-center px-2 py-0.5 rounded-full text-xs font-semibold"
                    style={{ 
                      backgroundColor: project.color || '#4b5563', // bg-gray-600 default
                      color: getContrastColor(project.color || '#4b5563') 
                    }}
                  >
                    <ProjectIcon /> {project.name}
                  </span>
                )}
              </div>
            </div>
          </div>
          <div className="w-full sm:w-auto flex-shrink-0 flex space-x-2 justify-end mt-3 sm:mt-0 sm:ml-4">
            <button
              onClick={() => onStartTimer(task)}
              className="p-2 text-green-400 hover:text-green-300 bg-green-900 bg-opacity-30 hover:bg-opacity-50 rounded-full transition-colors"
              title="Iniciar 5 min"
            >
              <TimerIcon />
            </button>
            <button
              onClick={() => onEdit(task)}
              className="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full transition-colors"
              aria-label="Editar tarea"
            >
              <EditIcon />
            </button>
            <button
              onClick={() => onDelete(task.id)}
              className="p-2 text-red-400 hover:text-red-300 hover:bg-gray-700 rounded-full transition-colors"
              aria-label="Eliminar tarea"
            >
              <TrashIcon />
            </button>
          </div>
        </div>
      );
    };

    // --- (MODIFICADO) Componente AddTaskForm (Híbrido IA / Manual) ---
    const AddTaskForm = ({ onAiAddTask, onManualAddTask, projects, defaultProjectId = null }) => {
      const [isAiMode, setIsAiMode] = useState(true); // Modo IA por defecto
      
      // Estado para modo IA
      const [aiPrompt, setAiPrompt] = useState('');
      
      // Estado para modo Manual
      const [manualText, setManualText] = useState('');
      const [manualDate, setManualDate] = useState('');
      const [manualTime, setManualTime] = useState('');
      
      // Estado compartido
      const [selectedProjectId, setSelectedProjectId] = useState(defaultProjectId || 'inbox');
      const [isLoading, setIsLoading] = useState(false);
      
      useEffect(() => {
        // Sincroniza el proyecto si el default cambia (al navegar en Proyectos)
        setSelectedProjectId(defaultProjectId || 'inbox');
      }, [defaultProjectId]);
      
      // Resetea los inputs al cambiar de modo
      useEffect(() => {
        setAiPrompt('');
        setManualText('');
        setManualDate('');
        setManualTime('');
      }, [isAiMode]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        
        if (isAiMode) {
          // --- Lógica MODO IA ---
          if (!aiPrompt.trim()) {
            setIsLoading(false);
            return;
          }
          try {
            await onAiAddTask(aiPrompt, selectedProjectId);
            setAiPrompt('');
            if (defaultProjectId === null) {
              setSelectedProjectId('inbox');
            }
          } catch (error) {
            // El error ya se maneja en onAiAddTask (con toast)
          }
        } else {
          // --- Lógica MODO MANUAL ---
          if (!manualText.trim()) {
            setIsLoading(false);
            return;
          }
          try {
            onManualAddTask({
              id: generateId(),
              text: manualText,
              date: manualDate,
              time: manualTime,
              projectId: selectedProjectId,
              status: 'pending'
            });
            // Limpiar formulario manual
            setManualText('');
            setManualDate('');
            setManualTime('');
            if (defaultProjectId === null) {
              setSelectedProjectId('inbox');
            }
          } catch (error) {
            console.error("Error al añadir tarea manual:", error);
          }
        }
        
        setIsLoading(false);
      };

      return (
        <form onSubmit={handleSubmit} className="p-4 bg-gray-800 rounded-xl shadow-lg mb-6">
          {/* Toggle de Modo */}
          <div className="flex bg-gray-700 rounded-lg p-1 mb-4">
            <button
              type="button"
              onClick={() => setIsAiMode(true)}
              className={`w-1/2 p-2 rounded-md font-semibold flex items-center justify-center transition-colors ${isAiMode ? 'bg-blue-600 text-white shadow' : 'text-gray-300 hover:bg-gray-600'}`}
            >
              <SparklesIcon /> <span className="ml-2">Modo IA</span>
            </button>
            <button
              type="button"
              onClick={() => setIsAiMode(false)}
              className={`w-1/2 p-2 rounded-md font-semibold flex items-center justify-center transition-colors ${!isAiMode ? 'bg-blue-600 text-white shadow' : 'text-gray-300 hover:bg-gray-600'}`}
            >
              <EditIcon /> <span className="ml-2">Modo Manual</span>
            </button>
          </div>

          {isAiMode ? (
            // --- Vista Modo IA ---
            <div>
              <textarea
                value={aiPrompt}
                onChange={(e) => setAiPrompt(e.target.value)}
                placeholder="Escribe tu tarea... (Ej: Reunión con el equipo mañana a las 10am)"
                className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none h-20 resize-none"
                disabled={isLoading}
              />
            </div>
          ) : (
            // --- Vista Modo Manual ---
            <div className="space-y-3">
              <input
                type="text"
                value={manualText}
                onChange={(e) => setManualText(e.target.value)}
                placeholder="Descripción de la tarea"
                className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400"
                disabled={isLoading}
              />
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <input
                  type="date"
                  value={manualDate}
                  onChange={(e) => setManualDate(e.target.value)}
                  className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"
                  disabled={isLoading}
                />
                <input
                  type="time"
                  value={manualTime}
                  onChange={(e) => setManualTime(e.target.value)}
                  className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"
                  disabled={isLoading}
                />
              </div>
            </div>
          )}
          
          {/* Controles Comunes (Proyecto y Submit) */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
            <select
              value={selectedProjectId}
              onChange={(e) => setSelectedProjectId(e.target.value)}
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"
              disabled={isLoading}
            >
              {projects.map(project => (
                <option key={project.id} value={project.id}>{project.name}</option>
              ))}
            </select>
            <button
              type="submit"
              className="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center disabled:opacity-50"
              disabled={isLoading}
            >
              {isLoading ? (
                <>
                  <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  {isAiMode ? 'Analizando...' : 'Añadiendo...'}
                </>
              ) : (
                <>
                  {isAiMode ? <SparklesIcon /> : <PlusIcon />}
                  <span className="ml-2">{isAiMode ? 'Añadir Tarea (IA)' : 'Añadir Tarea'}</span>
                </>
              )}
            </button>
          </div>
        </form>
      );
    };


    // --- Componente EditTaskForm ---
    const EditTaskForm = ({ task, onUpdate, onClose, projects, onDelete }) => {
      const [text, setText] = useState(task.text);
      const [dueDate, setDueDate] = useState(task.date);
      const [dueTime, setDueTime] = useState(task.time);
      const [projectId, setProjectId] = useState(task.projectId);
      const [showConfirmDelete, setShowConfirmDelete] = useState(false);

      const handleSubmit = (e) => {
        e.preventDefault();
        onUpdate(task.id, { text, date: dueDate, time: dueTime, projectId });
        onClose();
      };
      
      const handleDelete = () => {
        onDelete(task.id);
        onClose();
      }

      return (
        <form onSubmit={handleSubmit}>
          <h2 className="text-2xl font-bold text-white mb-6">Editar Tarea</h2>
          <input
            type="text"
            value={text}
            onChange={(e) => setText(e.target.value)}
            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white mb-4"
          />
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input
              type="date"
              value={dueDate}
              onChange={(e) => setDueDate(e.target.value)}
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"
            />
            <input
              type="time"
              value={dueTime}
              onChange={(e) => setDueTime(e.target.value)}
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"
            />
          </div>
          <select
            value={projectId}
            onChange={(e) => setProjectId(e.target.value)}
            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white mb-4"
          >
            {projects.map(project => (
              <option key={project.id} value={project.id}>{project.name}</option>
            ))}
          </select>
          
          {showConfirmDelete ? (
             <div className="flex justify-between items-center mt-6 bg-gray-700 p-4 rounded-lg">
               <p className="text-white">¿Seguro?</p>
               <div>
                 <button
                   type="button"
                   onClick={() => setShowConfirmDelete(false)}
                   className="p-2 px-4 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 mr-2"
                 >
                   Cancelar
                 </button>
                 <button
                   type="button"
                   onClick={handleDelete}
                   className="p-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700"
                 >
                   Sí, Eliminar
                 </button>
               </div>
             </div>
          ) : (
            <div className="flex justify-between mt-6">
              <button
                type="button"
                onClick={() => setShowConfirmDelete(true)}
                className="p-3 px-6 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700"
              >
                Eliminar
              </button>
              <div>
                <button
                  type="button"
                  onClick={onClose}
                  className="p-3 px-6 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 mr-2"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="p-3 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700"
                >
                  Guardar
                </button>
              </div>
            </div>
          )}
        </form>
      );
    };
    
    // --- (NUEVO) Componente TodayTimelineModal (Agenda Hoy) ---
    const TodayTimelineModal = ({ tasks, onClose, projects }) => {
      const tasksWithTime = useMemo(() => 
        tasks
          .filter(t => t.time && t.status !== 'completed')
          .sort((a, b) => a.time.localeCompare(b.time)),
        [tasks]
      );
      
      const tasksWithoutTime = useMemo(() =>
        tasks.filter(t => !t.time && t.status !== 'completed'),
        [tasks]
      );

      return (
        <Modal isOpen={true} onClose={onClose}>
          <h2 className="text-2xl font-bold text-white mb-6">Agenda de Hoy</h2>
          
          <h3 className="text-lg font-semibold text-blue-300 mb-3">Cronograma</h3>
          {tasksWithTime.length > 0 ? (
            <div className="relative pl-4 pt-2">
              {tasksWithTime.map(task => {
                const project = projects.find(p => p.id === task.projectId);
                return (
                  <div key={task.id} className="timeline-item">
                    <div className="timeline-dot"></div>
                    <div className="flex items-center justify-between">
                      <span className="text-lg font-semibold text-blue-400">{task.time}</span>
                      {project && (
                        <span 
                          className="px-2 py-0.5 rounded-full text-xs font-semibold"
                          style={{
                            backgroundColor: project.color || '#4b5563',
                            color: getContrastColor(project.color || '#4b5563')
                          }}
                        >
                          {project.name}
                        </span>
                      )}
                    </div>
                    <p className="text-white mt-1">{task.text}</p>
                  </div>
                );
              })}
            </div>
          ) : (
            <p className="text-gray-400 mb-6">No hay tareas con hora para hoy.</p>
          )}

          <h3 className="text-lg font-semibold text-blue-300 mb-3 mt-8">Tareas de todo el día</h3>
          {tasksWithoutTime.length > 0 ? (
            <div className="space-y-2">
              {tasksWithoutTime.map(task => (
                <div key={task.id} className="bg-gray-700 p-3 rounded-lg flex items-center">
                  <input type="checkbox" className="form-checkbox h-5 w-5 text-blue-500 bg-gray-600 border-gray-500 rounded" disabled />
                  <span className="ml-3 text-white">{task.text}</span>
                </div>
              ))}
            </div>
          ) : (
            <p className="text-gray-400">No hay tareas sin hora para hoy.</p>
          )}
          
          <button
            onClick={onClose}
            className="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors mt-8"
          >
            Cerrar
          </button>
        </Modal>
      );
    };

    // --- Vista Dashboard (Inicio) ---
    const DashboardView = ({ tasks, projects, onAiAddTask, onManualAddTask, onUpdateTask, onDeleteTask, onEditTask, onStartTimer }) => {
      const today = getTodayISO();
      const [showTimeline, setShowTimeline] = useState(false);

      const todayTasks = useMemo(() =>
        tasks
          .filter(task => task.date === today && task.status !== 'completed')
          .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59')),
        [tasks, today]
      );
      
      const sevenDayTasks = useMemo(() => {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);

        const sevenDaysFromNow = new Date(tomorrow);
        sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 6);
        sevenDaysFromNow.setHours(23, 59, 59, 999);

        return tasks
          .filter(task => {
            if (!task.date || task.status === 'completed') return false;
            try {
              const taskDate = new Date(task.date + 'T00:00:00');
              return taskDate >= tomorrow && taskDate <= sevenDaysFromNow;
            } catch(e) {
              return false;
            }
          })
          .sort((a, b) => (a.date + (a.time || '00:00')).localeCompare(b.date + (b.time || '00:00')));
      }, [tasks]);
      
      const completedTodayTasks = useMemo(() =>
        tasks
          .filter(task => task.status === 'completed' && (task.date === today || task.completedDate === today))
      , [tasks, today]);

      return (
        <div>
          <AddTaskForm 
            onAiAddTask={onAiAddTask} 
            onManualAddTask={onManualAddTask} // (NUEVO)
            projects={projects} 
            defaultProjectId={null}
          />
          
          <section className="mb-8">
            <div className="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
              <h3 className="text-xl font-semibold text-blue-400">Tareas para Hoy ({formatDate(today)})</h3>
              <button
                onClick={() => setShowTimeline(true)}
                className="flex items-center text-sm px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg"
              >
                <TimelineIcon />
                <span className="ml-1.5">Ver Agenda de Hoy</span>
              </button>
            </div>
            
            {todayTasks.length > 0 ? (
              todayTasks.map(task => (
                <TaskItem 
                  key={task.id} 
                  task={task} 
                  onToggleComplete={onUpdateTask} 
                  onEdit={onEditTask} 
                  onDelete={onDeleteTask}
                  onStartTimer={onStartTimer}
                  projects={projects}
                />
              ))
            ) : (
              <p className="text-gray-400 p-3 bg-gray-800 rounded-lg">¡Nada para hoy!</p>
            )}
          </section>

          <section className="mb-8">
            <h3 className="text-xl font-semibold text-blue-400 mb-4 border-b border-gray-700 pb-2">Próximos 7 Días</h3>
            {sevenDayTasks.length > 0 ? (
              sevenDayTasks.map(task => (
                <TaskItem 
                  key={task.id} 
                  task={task} 
                  onToggleComplete={onUpdateTask} 
                  onEdit={onEditTask} 
                  onDelete={onDeleteTask}
                  onStartTimer={onStartTimer}
                  projects={projects}
                />
              ))
            ) : (
              <p className="text-gray-400 p-3 bg-gray-800 rounded-lg">Nada programado para los próximos 7 días.</p>
            )}
          </section>

          {completedTodayTasks.length > 0 && (
            <section>
              <h3 className="text-lg font-semibold text-green-400 mb-4 border-b border-gray-700 pb-2">Completadas Hoy</h3>
              {completedTodayTasks.map(task => (
                <TaskItem 
                  key={task.id} 
                  task={task} 
                  onToggleComplete={onUpdateTask} 
                  onEdit={onEditTask} 
                  onDelete={onDeleteTask}
                  onStartTimer={onStartTimer}
                  projects={projects}
                />
              ))}
            </section>
          )}
          
          {showTimeline && (
            <TodayTimelineModal 
              tasks={todayTasks} 
              onClose={() => setShowTimeline(false)}
              projects={projects}
            />
          )}
        </div>
      );
    };

    // --- Vista Agenda (Calendario) ---
    const AgendaView = ({ tasks, onEditTask, projects }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const daysOfWeek = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

      const getCalendarDays = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const daysInMonth = lastDayOfMonth.getDate();
        let startDayOfWeek = firstDayOfMonth.getDay(); // 0 (Dom) - 6 (Sáb)
        
        // Ajustar para que la semana empiece en Lunes (1)
        if (startDayOfWeek === 0) startDayOfWeek = 6; // Domingo es 6
        else startDayOfWeek -= 1; // Lunes es 0, Martes 1, ...
        
        const days = [];
        const prevLastDay = new Date(year, month, 0).getDate();
        
        // Días del mes anterior
        for (let i = startDayOfWeek; i > 0; i--) {
          days.push({ date: new Date(year, month - 1, prevLastDay - i + 1), isCurrentMonth: false });
        }
        
        // Días del mes actual
        for (let i = 1; i <= daysInMonth; i++) {
          days.push({ date: new Date(year, month, i), isCurrentMonth: true });
        }
        
        // Días del mes siguiente
        const totalCells = 42; // 6 filas de 7 días
        const nextDays = totalCells - days.length;
        for (let i = 1; i <= nextDays; i++) {
          days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
        }
        return days;
      };

      const calendarDays = getCalendarDays();
      const todayISO = getTodayISO();

      return (
        <div className="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
          <div className="flex justify-between items-center mb-6">
            <button onClick={() => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1))} className="p-2 rounded-lg bg-gray-700 hover:bg-gray-600">&lt;</button>
            <h2 className="text-xl sm:text-2xl font-bold text-white capitalize">
              {currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}
            </h2>
            <button onClick={() => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1))} className="p-2 rounded-lg bg-gray-700 hover:bg-gray-600">&gt;</button>
          </div>
          <div className="grid grid-cols-7 gap-1 text-center font-semibold text-blue-300 mb-2">
            {daysOfWeek.map(day => <div key={day} className="text-xs sm:text-sm">{day}</div>)}
          </div>
          <div className="grid grid-cols-7 gap-1">
            {calendarDays.map(({ date, isCurrentMonth }, index) => {
              const dateISO = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
              
              const tasksForDay = tasks
                .filter(task => task.date === dateISO)
                .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
              
              const isToday = dateISO === todayISO;

              return (
                <div 
                  key={index}
                  className={`h-24 sm:h-32 rounded-lg p-2 ${isCurrentMonth ? 'bg-gray-700' : 'bg-gray-900 opacity-50'} ${isToday ? 'border-2 border-blue-500' : ''} overflow-y-auto`}
                >
                  <span className={`font-semibold text-xs sm:text-sm ${isToday ? 'text-blue-400' : 'text-white'}`}>
                    {date.getDate()}
                  </span>
                  <div className="mt-1 space-y-1">
                    {tasksForDay.map(task => {
                      const project = projects.find(p => p.id === task.projectId);
                      return (
                        <div 
                          key={task.id}
                          onClick={() => onEditTask(task)}
                          className={`text-xs p-1 rounded mb-1 cursor-pointer ${task.status === 'completed' ? 'bg-green-800 line-through opacity-70' : ''} hover:opacity-80`}
                          style={task.status !== 'completed' ? {
                            backgroundColor: project?.color || '#3b82f6', // default blue
                            color: getContrastColor(project?.color || '#3b82f6')
                          } : {}} // Usa estilos por defecto si está completada
                        >
                          {task.time && <span className="font-bold">{task.time}</span>} {task.text}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    // --- Vista Proyectos ---
    const ProjectsView = ({ 
      projects, tasks, onAddProject, onDeleteProject, 
      onAiAddTask, onManualAddTask, onUpdateTask, onDeleteTask, onEditTask, onStartTimer,
      onShowPlanner
    }) => {
      const [selectedProjectId, setSelectedProjectId] = useState('inbox');
      const [newProjectName, setNewProjectName] = useState('');
      const [newProjectDesc, setNewProjectDesc] = useState('');
      const [newProjectColor, setNewProjectColor] = useState(PROJECT_COLORS[0]);

      const handleAddProject = (e) => {
        e.preventDefault();
        if (!newProjectName.trim()) return;
        onAddProject({ 
          id: generateId(), 
          name: newProjectName, 
          description: newProjectDesc,
          color: newProjectColor
        });
        setNewProjectName('');
        setNewProjectDesc('');
        setNewProjectColor(PROJECT_COLORS[0]);
      };

      const selectedProject = useMemo(() => 
        projects.find(p => p.id === selectedProjectId) || { id: 'inbox', name: 'Bandeja de entrada', description: 'Tareas sin proyecto' },
        [projects, selectedProjectId]
      );

      const tasksForProject = useMemo(() =>
        tasks.filter(t => t.projectId === selectedProjectId),
        [tasks, selectedProjectId]
      );

      return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Columna de Proyectos */}
          <div className="lg:col-span-1 bg-gray-800 rounded-xl shadow-lg p-6 h-fit self-start">
            <h2 className="text-2xl font-bold text-white mb-4">Proyectos</h2>
            
            <button
              onClick={onShowPlanner}
              className="w-full p-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 mb-6 flex items-center justify-center"
            >
              <SparklesIcon /> <span className="ml-2">Planificador de Estudio IA</span>
            </button>
            
            <form onSubmit={handleAddProject} className="mb-6">
              <input
                type="text"
                value={newProjectName}
                onChange={(e) => setNewProjectName(e.target.value)}
                placeholder="Nombre del nuevo proyecto"
                className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white mb-2"
              />
              <textarea
                value={newProjectDesc}
                onChange={(e) => setNewProjectDesc(e.target.value)}
                placeholder="Descripción (opcional)"
                className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white mb-3 h-20 resize-none"
              />
              {/* Selector de Color */}
              <div className="flex justify-between my-3 px-1">
                {PROJECT_COLORS.map(color => (
                  <button
                    type="button"
                    key={color}
                    onClick={() => setNewProjectColor(color)}
                    className={`w-8 h-8 rounded-full border-2 transition-all ${newProjectColor === color ? 'border-white scale-110' : 'border-transparent opacity-70'}`}
                    style={{ backgroundColor: color }}
                    title={color}
                  ></button>
                ))}
              </div>
              
              <button type="submit" className="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">
                Crear Proyecto
              </button>
            </form>
            
            <div className="space-y-3">
              {projects.map(project => (
                <div 
                  key={project.id}
                  onClick={() => setSelectedProjectId(project.id)}
                  className={`flex justify-between items-center p-4 rounded-lg cursor-pointer ${selectedProjectId === project.id ? 'bg-blue-600 text-white' : 'bg-gray-700 text-white hover:bg-gray-600'}`}
                >
                  <div className="flex items-center min-w-0">
                    <span 
                      className="w-4 h-4 rounded-full mr-3 flex-shrink-0 border border-gray-900"
                      style={{ backgroundColor: project.color || '#4b5563' }}
                    ></span>
                    <span className="font-medium truncate">{project.name}</span>
                  </div>
                  {project.id !== 'inbox' && (
                    <button 
                      onClick={(e) => { e.stopPropagation(); onDeleteProject(project.id); }}
                      className="p-1 text-red-400 hover:text-red-300 flex-shrink-0"
                    >
                      <TrashIcon />
                    </button>
                  )}
                </div>
              ))}
            </div>
          </div>

          {/* Columna de Tareas del Proyecto */}
          <div className="lg:col-span-2">
            <div className="bg-gray-800 rounded-xl shadow-lg p-6">
              <h2 className="text-3xl font-bold text-white mb-2">{selectedProject.name}</h2>
              {selectedProject.description && (
                <p className="text-gray-300 mb-6">{selectedProject.description}</p>
              )}
              
              <h3 className="text-xl font-semibold text-blue-400 mb-4">Añadir Tarea al Proyecto</h3>
              <AddTaskForm 
                onAiAddTask={onAiAddTask}
                onManualAddTask={onManualAddTask} // (NUEVO)
                projects={projects} 
                defaultProjectId={selectedProject.id}
              />
              
              <div className="space-y-3 mt-6">
                {tasksForProject.length > 0 ? (
                  tasksForProject.map(task => (
                    <TaskItem 
                      key={task.id} 
                      task={task} 
                      onToggleComplete={onUpdateTask} 
                      onEdit={onEditTask} 
                      onDelete={onDeleteTask}
                      onStartTimer={onStartTimer}
                      projects={projects}
                    />
                  ))
                ) : (
                  <p className="text-gray-400 p-3 bg-gray-700 rounded-lg">Este proyecto no tiene tareas.</p>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // --- Vista Anotaciones (Diario) ---
    const NotesView = () => {
      const [folders, setFolders] = useLocalStorage('notes_folders', [{ id: 'general', name: 'General' }]);
      const [notes, setNotes] = useLocalStorage('notes', []);
      const [selectedFolderId, setSelectedFolderId] = useState('general');
      const [selectedNoteId, setSelectedNoteId] = useState(null);
      const [newFolderName, setNewFolderName] = useState('');
      
      const notesInFolder = useMemo(() => 
        notes.filter(n => n.folderId === selectedFolderId).sort((a, b) => b.updatedAt - a.updatedAt)
      , [notes, selectedFolderId]);
      
      const selectedNote = useMemo(() => 
        notes.find(n => n.id === selectedNoteId)
      , [notes, selectedNoteId]);

      const handleAddFolder = () => {
        if (!newFolderName.trim()) return;
        setFolders(prev => [...prev, { id: generateId(), name: newFolderName }]);
        setNewFolderName('');
      };
      
      const handleAddNote = () => {
        const newNote = {
          id: generateId(),
          folderId: selectedFolderId,
          title: 'Nueva Nota',
          content: '',
          updatedAt: Date.now()
        };
        setNotes(prev => [newNote, ...prev]);
        setSelectedNoteId(newNote.id);
      };
      
      const handleUpdateNote = (field, value) => {
        setNotes(prev => prev.map(n => 
          n.id === selectedNoteId 
            ? { ...n, [field]: value, updatedAt: Date.now() } 
            : n
        ));
      };
      
      const handleDeleteNote = (id) => {
        setNotes(prev => prev.filter(n => n.id !== id));
        if (selectedNoteId === id) {
          setSelectedNoteId(null);
        }
      };

      return (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 h-[75vh]">
          {/* Carpetas */}
          <div className="md:col-span-1 bg-gray-800 rounded-xl p-4 overflow-y-auto h-full">
            <h2 className="text-xl font-bold mb-4">Carpetas</h2>
            <div className="mb-4">
              <input
                type="text"
                value={newFolderName}
                onChange={(e) => setNewFolderName(e.target.value)}
                placeholder="Nueva carpeta"
                className="w-full p-2 bg-gray-700 rounded"
              />
              <button onClick={handleAddFolder} className="w-full p-2 bg-blue-600 mt-2 rounded">Crear</button>
            </div>
            <div className="space-y-2">
              {folders.map(folder => (
                <div
                  key={folder.id}
                  onClick={() => { setSelectedFolderId(folder.id); setSelectedNoteId(null); }}
                  className={`flex items-center p-3 rounded cursor-pointer ${selectedFolderId === folder.id ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`}
                >
                  <FolderIcon /> {folder.name}
                </div>
              ))}
            </div>
          </div>
          
          {/* Notas */}
          <div className="md:col-span-1 bg-gray-800 rounded-xl p-4 overflow-y-auto h-full">
            <button onClick={handleAddNote} className="w-full p-2 bg-green-600 mb-4 rounded">Nueva Nota</button>
            <div className="space-y-2">
              {notesInFolder.map(note => (
                <div
                  key={note.id}
                  onClick={() => setSelectedNoteId(note.id)}
                  className={`p-3 rounded cursor-pointer ${selectedNoteId === note.id ? 'bg-gray-600' : 'bg-gray-700 hover:bg-gray-600'}`}
                >
                  <h3 className="font-semibold truncate">{note.title || 'Sin Título'}</h3>
                  <p className="text-sm text-gray-400 truncate">{note.content ? new Date(note.updatedAt).toLocaleString('es-ES') : 'Vacía'}</p>
                </div>
              ))}
            </div>
          </div>

          {/* Editor */}
          <div className="md:col-span-2 bg-gray-800 rounded-xl p-4 h-full flex flex-col">
            {selectedNote ? (
              <>
                <input
                  type="text"
                  value={selectedNote.title}
                  onChange={(e) => handleUpdateNote('title', e.target.value)}
                  placeholder="Título"
                  className="w-full p-3 bg-gray-700 text-xl font-bold rounded mb-4"
                />
                <textarea
                  value={selectedNote.content}
                  onChange={(e) => handleUpdateNote('content', e.target.value)}
                  placeholder="Escribe algo..."
                  className="w-full p-3 bg-gray-700 rounded flex-grow resize-none"
                />
                <button
                  onClick={() => handleDeleteNote(selectedNote.id)}
                  className="w-full p-2 bg-red-600 mt-4 rounded"
                >
                  Eliminar Nota
                </button>
              </>
            ) : (
              <div className="flex items-center justify-center h-full text-gray-400">
                <p>Selecciona una nota para editar o crea una nueva.</p>
              </div>
            )}
          </div>
        </div>
      );
    };

    // --- (ACTUALIZADO) Vista Estudio (Pomodoro + Métricas) ---
    const StudyView = ({ tasks, themes, onAddTask, onUpdateTask, onDeleteTask, onAddTheme, onPomodoroComplete, totalWorkTime }) => {
      const POMODORO_DEFAULT = 25 * 60;
      const [timer, setTimer] = useState(POMODORO_DEFAULT);
      const [isTimerActive, setIsTimerActive] = useState(false);
      const [pomodoroDuration, setPomodoroDuration] = useState(POMODORO_DEFAULT);
      const intervalRef = useRef(null);
      const showToast = useToast();
      
      const [newTheme, setNewTheme] = useState('');
      const [selectedThemeId, setSelectedThemeId] = useState('all');

      // Efecto del temporizador
      useEffect(() => {
        if (isTimerActive) {
          intervalRef.current = setInterval(() => {
            setTimer(t => {
              if (t <= 1) {
                clearInterval(intervalRef.current);
                setIsTimerActive(false);
                onPomodoroComplete(pomodoroDuration); // Registra el tiempo trabajado
                showToast(`¡Pomodoro de ${pomodoroDuration / 60} min completado!`, 'success');
                return pomodoroDuration; // Reinicia al tiempo original
              }
              return t - 1;
            });
          }, 1000);
        } else {
          clearInterval(intervalRef.current);
        }
        return () => clearInterval(intervalRef.current);
      }, [isTimerActive, pomodoroDuration, onPomodoroComplete, showToast]);

      const formatTime = (timeInSeconds) => {
        const minutes = Math.floor(timeInSeconds / 60);
        const seconds = timeInSeconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      };
      
      const formatTotalWorkTime = (timeInSeconds) => {
        const hours = Math.floor(timeInSeconds / 3600);
        const minutes = Math.floor((timeInSeconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
      };

      const toggleTimer = () => setIsTimerActive(prev => !prev);
      const resetTimer = () => {
        setIsTimerActive(false);
        setTimer(pomodoroDuration);
      };

      const changeDuration = (amount) => {
        if (isTimerActive) return;
        setPomodoroDuration(prev => {
          const newTime = Math.max(300, prev + amount * 300); // Mínimo 5 minutos (300s)
          setTimer(newTime);
          return newTime;
        });
      };
      
      // Lógica de Tareas de Estudio
      const [taskText, setTaskText] = useState('');
      const [taskTheme, setTaskTheme] = useState('general');
      
      const handleAddTask = (e) => {
        e.preventDefault();
        if (!taskText.trim()) return;
        onAddTask({
          id: generateId(),
          text: taskText,
          themeId: taskTheme,
          status: 'pending'
        });
        setTaskText('');
      };
      
      const handleAddTheme = (e) => {
        e.preventDefault();
        if (!newTheme.trim()) return;
        onAddTheme({ id: generateId(), name: newTheme });
        setNewTheme('');
      };
      
      const filteredTasks = useMemo(() => {
        if (selectedThemeId === 'all') return tasks;
        return tasks.filter(t => t.themeId === selectedThemeId);
      }, [tasks, selectedThemeId]);
      
      // (NUEVO) Métricas de Estudio
      const pendingTasksCount = useMemo(() => 
        filteredTasks.filter(t => t.status === 'pending').length
      , [filteredTasks]);
      
      const estimatedTime = pendingTasksCount * pomodoroDuration; // Tiempo en segundos
      
      const estimatedFinishTime = useMemo(() => {
        if (estimatedTime === 0) return null;
        const now = new Date();
        const finishDate = new Date(now.getTime() + estimatedTime * 1000);
        return finishDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
      }, [estimatedTime]);

      return (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Columna Pomodoro y Métricas */}
          <div className="bg-gray-800 rounded-xl p-6 h-fit">
            <h2 className="text-2xl font-bold text-white mb-6 text-center">Temporizador Pomodoro</h2>
            <div className="text-7xl sm:text-8xl font-bold text-center text-blue-400 my-8">
              {formatTime(timer)}
            </div>
            <div className="flex justify-center space-x-4 mb-6">
              <button 
                onClick={toggleTimer} 
                className={`p-4 rounded-full ${isTimerActive ? 'bg-yellow-500' : 'bg-green-500'} text-white transition-colors`}
              >
                {isTimerActive ? <PauseIcon /> : <PlayIcon />}
              </button>
              <button onClick={resetTimer} className="p-4 rounded-full bg-gray-600 text-white flex items-center justify-center">
                <RefreshIcon />
              </button>
            </div>
            <div className="flex justify-center items-center space-x-4">
              <button onClick={() => changeDuration(-5)} disabled={isTimerActive} className="p-2 px-4 rounded-lg bg-gray-700 disabled:opacity-50">- 5 min</button>
              <span className="text-lg font-medium">{pomodoroDuration / 60} min</span>
              <button onClick={() => changeDuration(5)} disabled={isTimerActive} className="p-2 px-4 rounded-lg bg-gray-700 disabled:opacity-50">+ 5 min</button>
            </div>
            
            {/* (NUEVO) Métricas de Estudio */}
            <div className="mt-8 pt-6 border-t border-gray-700">
              <h3 className="text-xl font-semibold text-white mb-4">Métricas de la Sesión</h3>
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-gray-700 p-4 rounded-lg">
                  <p className="text-sm text-gray-400">Tareas Pendientes</p>
                  <p className="text-2xl font-bold text-white">{pendingTasksCount}</p>
                </div>
                <div className="bg-gray-700 p-4 rounded-lg">
                  <p className="text-sm text-gray-400">Tiempo Estimado</p>
                  <p className="text-2xl font-bold text-white">{formatTime(estimatedTime)}</p>
                </div>
                <div className="bg-gray-700 p-4 rounded-lg">
                  <p className="text-sm text-gray-400">Hora Fin (Est.)</p>
                  <p className="text-2xl font-bold text-white">{estimatedFinishTime || '---'}</p>
                </div>
                <div className="bg-gray-700 p-4 rounded-lg">
                  <p className="text-sm text-gray-400">Tiempo Total Trab.</p>
                  <p className="text-2xl font-bold text-white">{formatTotalWorkTime(totalWorkTime)}</p>
                </div>
              </div>
            </div>
          </div>
          
          {/* Columna Tareas de Estudio */}
          <div className="bg-gray-800 rounded-xl p-6">
            <h2 className="text-2xl font-bold text-white mb-4">Tareas de Estudio</h2>
            
            {/* Formulario Añadir Tarea */}
            <form onSubmit={handleAddTask} className="flex gap-2 mb-4">
              <input
                type="text"
                value={taskText}
                onChange={(e) => setTaskText(e.target.value)}
                placeholder="Nueva tarea de estudio"
                className="flex-grow p-3 bg-gray-700 rounded"
              />
              <select 
                value={taskTheme} 
                onChange={(e) => setTaskTheme(e.target.value)}
                className="p-3 bg-gray-700 rounded"
              >
                {themes.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
              </select>
              <button type="submit" className="p-3 bg-blue-600 rounded">
                <PlusIcon />
              </button>
            </form>
            
            {/* Filtros y Temas */}
            <div className="flex flex-col sm:flex-row gap-2 mb-4">
              <select 
                value={selectedThemeId} 
                onChange={(e) => setSelectedThemeId(e.target.value)}
                className="p-2 bg-gray-700 rounded"
              >
                <option value="all">Todos los Temas</option>
                {themes.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
              </select>
              <form onSubmit={handleAddTheme} className="flex gap-2">
                <input
                  type="text"
                  value={newTheme}
                  onChange={(e) => setNewTheme(e.target.value)}
                  placeholder="Nuevo tema"
                  className="flex-grow p-2 bg-gray-700 rounded"
                />
                <button type="submit" className="p-2 bg-gray-600 rounded">Crear</button>
              </form>
            </div>
            
            {/* Lista de Tareas */}
            <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
              {filteredTasks.length > 0 ? filteredTasks.map(task => (
                <div key={task.id} className={`flex justify-between items-center p-3 bg-gray-700 rounded ${task.status === 'completed' ? 'opacity-50' : ''}`}>
                  <div className="flex items-center">
                    <input
                      type="checkbox"
                      checked={task.status === 'completed'}
                      onChange={() => onUpdateTask(task.id, { ...task, status: task.status === 'completed' ? 'pending' : 'completed' })}
                      className="form-checkbox h-5 w-5 text-blue-500 bg-gray-600 border-gray-500 rounded"
                    />
                    <span className={`ml-3 ${task.status === 'completed' ? 'line-through' : ''}`}>{task.text}</span>
                  </div>
                  <button onClick={() => onDeleteTask(task.id)} className="p-1 text-red-400">
                    <TrashIcon />
                  </button>
                </div>
              )) : (
                <p className="text-gray-400 p-3 bg-gray-700 rounded-lg">No hay tareas de estudio en este tema.</p>
              )}
            </div>
            
          </div>
        </div>
      );
    };

    // --- Componente Planificador de Estudio IA ---
    const StudyPlannerAI = ({ onClose, themes, onAddTheme, onAddTasks }) => {
      const [plans, setPlans] = useLocalStorage('study_plans', []);
      const [currentPlanId, setCurrentPlanId] = useState(null);
      const [newPlanName, setNewPlanName] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const showToast = useToast();

      const currentPlan = useMemo(() => plans.find(p => p.id === currentPlanId), [plans, currentPlanId]);

      const handleAddPlan = () => {
        if (!newPlanName.trim()) return;
        const newPlan = {
          id: generateId(),
          name: newPlanName,
          syllabus: '', // Temario
          generatedSchedule: null // { theme: '...', tasks: [...] }
        };
        setPlans(prev => [newPlan, ...prev]);
        setCurrentPlanId(newPlan.id);
        setNewPlanName('');
      };

      const updatePlan = (field, value) => {
        setPlans(prev => prev.map(p => p.id === currentPlanId ? { ...p, [field]: value } : p));
      };
      
      const deletePlan = (id) => {
        setPlans(prev => prev.filter(p => p.id !== id));
        if (currentPlanId === id) {
          setCurrentPlanId(null);
        }
      };

      const handleGenerateSchedule = async () => {
        if (!currentPlan || !currentPlan.syllabus) {
          showToast('Por favor, pega tu temario primero.', 'error');
          return;
        }
        setIsGenerating(true);
        
        const systemPrompt = `
Eres un asistente de planificación de estudios. Tu trabajo es tomar un temario y convertirlo en un plan de estudio JSON.
El plan debe tener dos claves:
1.  'theme': Un nombre corto para el tema principal o materia (ej. "Historia", "React", "Marketing Digital").
2.  'tasks': Un array de strings, donde cada string es un bloque de estudio accionable.
Genera entre 5 y 15 bloques de estudio, dependiendo del temario.
No añadas fechas ni horas. Solo la lista de tareas.
`;
        const schema = {
          type: "OBJECT",
          properties: {
            "theme": { "type": "STRING", "description": "El nombre del tema o materia." },
            "tasks": { 
              "type": "ARRAY", 
              "items": { "type": "STRING" },
              "description": "Un array de tareas (bloques de estudio)." 
            }
          },
          required: ["theme", "tasks"]
        };

        try {
          const resultJson = await callGemini(currentPlan.syllabus, schema, systemPrompt);
          updatePlan('generatedSchedule', resultJson);
          showToast('¡Cronograma generado!', 'success');
        } catch (e) {
          console.error(e);
          showToast('Error al generar el cronograma.', 'error');
        } finally {
          setIsGenerating(false);
        }
      };
      
      const handleConfirmSchedule = () => {
        if (!currentPlan || !currentPlan.generatedSchedule) return;
        
        const { theme, tasks: taskTexts } = currentPlan.generatedSchedule;
        
        // 1. Crear el tema si no existe
        let themeObj = themes.find(t => t.name.toLowerCase() === theme.toLowerCase());
        if (!themeObj) {
          themeObj = { id: generateId(), name: theme };
          onAddTheme(themeObj);
        }
        
        // 2. Crear las tareas
        const newTasks = taskTexts.map(text => ({
          id: generateId(),
          text: text,
          themeId: themeObj.id,
          status: 'pending'
        }));
        
        onAddTasks(newTasks);
        showToast(`Se añadieron ${newTasks.length} tareas a "${themeObj.name}"`, 'success');
        onClose();
      };

      return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 h-[75vh]">
          {/* Columna de Planes */}
          <div className="md:col-span-1 bg-gray-700 rounded-xl p-4 overflow-y-auto h-full">
            <h3 className="text-xl font-bold mb-4">Planes de Estudio</h3>
            <div className="flex gap-2 mb-4">
              <input
                type="text"
                value={newPlanName}
                onChange={(e) => setNewPlanName(e.target.value)}
                placeholder="Nuevo Plan"
                className="flex-grow p-2 bg-gray-600 rounded"
              />
              <button onClick={handleAddPlan} className="p-2 bg-blue-600 rounded">
                <PlusIcon />
              </button>
            </div>
            <div className="space-y-2">
              {plans.map(plan => (
                <div
                  key={plan.id}
                  onClick={() => setCurrentPlanId(plan.id)}
                  className={`flex justify-between items-center p-3 rounded cursor-pointer ${currentPlanId === plan.id ? 'bg-blue-600' : 'bg-gray-600 hover:bg-gray-500'}`}
                >
                  <span className="truncate">{plan.name}</span>
                  <button 
                    onClick={(e) => { e.stopPropagation(); deletePlan(plan.id); }} 
                    className="p-1 text-red-400 hover:text-red-300 ml-2 flex-shrink-0"
                  >
                    <TrashIcon />
                  </button>
                </div>
              ))}
            </div>
          </div>
          
          {/* Columna Editor y Resultado */}
          {currentPlan ? (
            <>
              {/* Editor de Temario */}
              <div className="md:col-span-1 bg-gray-700 rounded-xl p-4 h-full flex flex-col">
                <input
                  type="text"
                  value={currentPlan.name}
                  onChange={(e) => updatePlan('name', e.target.value)}
                  className="w-full p-2 bg-gray-600 text-xl font-bold rounded mb-4"
                />
                <textarea
                  value={currentPlan.syllabus}
                  onChange={(e) => updatePlan('syllabus', e.target.value)}
                  placeholder="Pega tu temario o plan de estudio aquí..."
                  className="w-full p-3 bg-gray-600 rounded flex-grow resize-none"
                />
                <button
                  onClick={handleGenerateSchedule}
                  disabled={isGenerating}
                  className="w-full p-3 bg-purple-600 mt-4 rounded flex items-center justify-center disabled:opacity-50"
                >
                  {isGenerating ? 'Generando...' : 'Generar Cronograma (IA)'}
                </button>
              </div>
              
              {/* Cronograma Generado */}
              <div className="md:col-span-1 bg-gray-700 rounded-xl p-4 h-full overflow-y-auto">
                <h3 className="text-xl font-bold mb-4">Cronograma Sugerido</h3>
                {currentPlan.generatedSchedule ? (
                  <>
                    <h4 className="text-lg font-semibold text-blue-300 mb-2">Tema: {currentPlan.generatedSchedule.theme}</h4>
                    <ul className="list-disc list-inside space-y-2">
                      {currentPlan.generatedSchedule.tasks.map((task, index) => (
                        <li key={index}>{task}</li>
                      ))}
                    </ul>
                    <button
                      onClick={handleConfirmSchedule}
                      className="w-full p-3 bg-green-600 mt-6 rounded"
                    >
                      Confirmar y Crear Tareas
                    </button>
                  </>
                ) : (
                  <p className="text-gray-400">Genera un cronograma para ver los resultados.</p>
                )}
              </div>
            </>
          ) : (
            <div className="md:col-span-2 bg-gray-700 rounded-xl p-4 h-full flex items-center justify-center">
              <p className="text-gray-400">Selecciona o crea un plan de estudio.</p>
            </div>
          )}
        </div>
      );
    };

    // --- Componente Temporizador Flotante ---
    const TimerDisplay = ({ task, onStop }) => {
      const [timeLeft, setTimeLeft] = useState(5 * 60); // 5 minutos

      useEffect(() => {
        if (timeLeft <= 0) {
          onStop(true); // true = completado
          return;
        }
        const timerId = setInterval(() => {
          setTimeLeft(t => t - 1);
        }, 1000);
        return () => clearInterval(timerId);
      }, [timeLeft, onStop]);

      const formatTime = (timeInSeconds) => {
        const minutes = Math.floor(timeInSeconds / 60);
        const seconds = timeInSeconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      };

      return (
        <div className="fixed bottom-4 right-4 bg-gray-800 border-2 border-blue-500 shadow-lg rounded-xl p-4 w-80 z-50">
          <p className="text-sm text-gray-300">Enfocado en:</p>
          <p className="text-lg font-semibold truncate mb-2">{task.text}</p>
          <div className="text-4xl font-bold text-center text-blue-400 my-3">
            {formatTime(timeLeft)}
          </div>
          <button
            onClick={() => onStop(false)} // false = no completado
            className="w-full p-2 bg-red-600 text-white font-semibold rounded-lg"
          >
            Detener
          </button>
        </div>
      );
    };

    // --- Componente Principal: App ---
    function App() {
      const [view, setView] = useState('dashboard');
      const [tasks, setTasks] = useLocalStorage('tasks', []);
      const [projects, setProjects] = useLocalStorage('projects', [{ 
        id: 'inbox', 
        name: 'Bandeja de entrada', 
        description: 'Tareas sin proyecto específico',
        color: '#6b7280' // gray-500
      }]);
      
      // Estado de Estudio (centralizado)
      const [studyTasks, setStudyTasks] = useLocalStorage('study_tasks', []);
      const [studyThemes, setStudyThemes] = useLocalStorage('study_themes', [{ id: 'general', name: 'General' }]);
      // (NUEVO) Estado de métricas de estudio
      const [totalWorkTime, setTotalWorkTime] = useLocalStorage('study_total_work_time', 0);
      
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingTask, setEditingTask] = useState(null);
      const [focusTask, setFocusTask] = useState(null); // Tarea para el temporizador de 5 min
      
      const [isPlannerOpen, setIsPlannerOpen] = useState(false);
      
      const showToast = useToast();

      // --- Funciones CRUD de Tareas ---
      const handleAddTask = (task) => {
        setTasks(prev => [task, ...prev]);
        showToast('¡Tarea creada manualmente!', 'success');
      };
      
      // (CORREGIDO) Función de añadir tarea con IA
      const handleAiAddTask = async (prompt, selectedProjectId) => {
        const today = getTodayISO();
        const tomorrow = getTomorrowISO();

        // (MODIFICADO) Mover el contexto de fecha al prompt principal para mayor claridad
        const enhancedPrompt = `
Contexto de Fechas:
- La fecha de hoy es: ${today}
- La fecha de mañana es: ${tomorrow}

Tarea del Usuario:
"${prompt}"

Instrucción:
Analiza la "Tarea del Usuario" usando el "Contexto de Fechas" y extrae los detalles en el formato JSON requerido.
Si la tarea dice "hoy" o "para hoy", usa la fecha ${today}.
Si la tarea dice "mañana", usa la fecha ${tomorrow}.
Extrae solo el texto de la tarea, sin la fecha/hora.
`;

        // (MODIFICADO) El SystemPrompt ahora es solo sobre el ROL y el FORMATO.
        const systemPrompt = `
Eres un asistente de agenda. Tu única función es tomar el texto del usuario y convertirlo en un objeto JSON estructurado, siguiendo el esquema.
El formato de fecha de salida DEBE ser 'YYYY-MM-DD'.
El formato de hora de salida DEBE ser 'HH:mm' (24 horas).
Si no se especifica una hora, el campo 'time' debe ser una cadena vacía ('').
Si no se especifica una fecha, el campo 'date' debe ser una cadena vacía ('').
El campo 'text' debe ser solo la descripción de la tarea.
NO intentes adivinar el proyecto.
`;
        const schema = {
          type: "OBJECT",
          properties: {
            "text": { "type": "STRING", "description": "La descripción de la tarea." },
            "date": { "type": "STRING", "description": "La fecha de la tarea en formato YYYY-MM-DD. Vacío si no se especifica." },
            "time": { "type": "STRING", "description": "La hora de la tarea en formato HH:mm. Vacío si no se especifica." }
          },
          required: ["text", "date", "time"]
        };
        
        try {
          // (MODIFICADO) Usar el 'enhancedPrompt' en lugar del 'prompt' simple
          const resultJson = await callGemini(enhancedPrompt, schema, systemPrompt);
          
          // (MODIFICADO) Quitar el parche anterior. 
          // Confiamos en que la IA ahora procesará la fecha correctamente.
          setTasks(prev => [
            {
              id: generateId(),
              text: resultJson.text || prompt, // Fallback al prompt si el texto está vacío
              date: resultJson.date || '', // Usar directamente el resultado de la IA
              time: resultJson.time || '',
              projectId: selectedProjectId, // Usa el ID seleccionado manualmente
              status: 'pending'
            },
            ...prev
          ]);
          showToast('¡Tarea creada por IA!', 'success');

        } catch (error) {
          console.error('Error procesando tarea con IA:', error);
          showToast('Error de la IA: No se pudo analizar la tarea.', 'error');
          // Fallback: crear la tarea con el texto plano
          setTasks(prev => [
            {
              id: generateId(),
              text: prompt, // Tarea de texto plano
              date: '',
              time: '',
              projectId: selectedProjectId, // Usa el ID seleccionado manually
              status: 'pending'
            }, 
            ...prev
          ]);
          showToast('Se creó una tarea simple sin fecha.', 'info');
          throw error; // Propagar el error para que el formulario sepa que falló
        }
      };


      const handleUpdateTask = (id, updatedTask) => {
        setTasks(prev => prev.map(t => (t.id === id ? { ...t, ...updatedTask } : t)));
      };

      const handleToggleComplete = (id) => {
        const today = getTodayISO();
        setTasks(prev => prev.map(t =>
          t.id === id
            ? { 
                ...t, 
                status: t.status === 'completed' ? 'pending' : 'completed',
                completedDate: t.status !== 'completed' ? today : null // (NUEVO) Sella la fecha de completado
              }
            : t
        ));
      };

      const handleDeleteTask = (id) => {
        setTasks(prev => prev.filter(t => t.id !== id));
      };
      
      // --- Funciones CRUD de Proyectos ---
      const handleAddProject = (project) => {
        setProjects(prev => [project, ...prev]);
      };
      
      const handleDeleteProject = (id) => {
        if (id === 'inbox') return;
        setProjects(prev => prev.filter(p => p.id !== id));
        // Opcional: Reasignar tareas huerfanas a 'inbox'
        setTasks(prev => prev.map(t => t.projectId === id ? { ...t, projectId: 'inbox' } : t));
      };
      
      // --- Funciones CRUD de Estudio ---
      const handleAddStudyTask = (task) => setStudyTasks(prev => [task, ...prev]);
      const handleAddStudyTasks = (tasks) => setStudyTasks(prev => [...tasks, ...prev]);
      const handleUpdateStudyTask = (id, updatedTask) => {
        setStudyTasks(prev => prev.map(t => (t.id === id ? updatedTask : t)));
      };
      const handleDeleteStudyTask = (id) => setStudyTasks(prev => prev.filter(t => t.id !== id));
      const handleAddStudyTheme = (theme) => setStudyThemes(prev => [theme, ...prev]);
      
      // (NUEVO) Callback de Pomodoro
      const handlePomodoroComplete = (secondsWorked) => {
        setTotalWorkTime(prev => prev + secondsWorked);
      };

      // --- Handlers de Modal ---
      const handleEditTask = (task) => {
        setEditingTask(task);
        setIsModalOpen(true);
      };
      const handleCloseModal = () => {
        setIsModalOpen(false);
        setEditingTask(null);
      };
      
      // --- Handlers de Timer 5 min ---
      const handleStartTimer = (task) => {
        setFocusTask(task);
      };
      const handleStopTimer = (completed) => {
        if (completed && focusTask) {
          handleToggleComplete(focusTask.id);
          showToast(`¡Tarea "${focusTask.text}" completada!`, 'success');
        }
        setFocusTask(null);
      };
      
      // --- Renderizado de Vista ---
      const renderView = () => {
        switch (view) {
          case 'dashboard':
            return <DashboardView 
              tasks={tasks} 
              projects={projects}
              onAiAddTask={handleAiAddTask}
              onManualAddTask={handleAddTask}
              onUpdateTask={handleToggleComplete}
              onDeleteTask={handleDeleteTask}
              onEditTask={handleEditTask}
              onStartTimer={handleStartTimer}
            />;
          case 'agenda':
            return <AgendaView 
              tasks={tasks} 
              projects={projects}
              onEditTask={handleEditTask}
            />;
          case 'projects':
            return <ProjectsView 
              projects={projects}
              tasks={tasks}
              onAddProject={handleAddProject}
              onDeleteProject={handleDeleteProject}
              onAiAddTask={handleAiAddTask}
              onManualAddTask={handleAddTask}
              onUpdateTask={handleToggleComplete}
              onDeleteTask={handleDeleteTask}
              onEditTask={handleEditTask}
              onStartTimer={handleStartTimer}
              onShowPlanner={() => setIsPlannerOpen(true)}
            />;
          case 'notes':
            return <NotesView />;
          case 'study':
            return <StudyView 
              tasks={studyTasks}
              themes={studyThemes}
              onAddTask={handleAddStudyTask}
              onUpdateTask={handleUpdateStudyTask}
              onDeleteTask={handleDeleteStudyTask}
              onAddTheme={handleAddStudyTheme}
              onPomodoroComplete={handlePomodoroComplete}
              totalWorkTime={totalWorkTime}
            />;
          default:
            return null;
        }
      };

      return (
        <div className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
          
          <header className="mb-6 sm:mb-8">
            <h1 className="text-4xl font-bold text-white mb-6 text-center sm:text-left">Mi Agenda Digital</h1>
            <nav className="flex flex-wrap justify-center bg-gray-800 rounded-lg p-2 shadow-lg gap-1">
              {[
                { id: 'dashboard', label: 'Inicio', icon: <DashboardIcon /> },
                { id: 'agenda', label: 'Agenda', icon: <CalendarIcon /> },
                { id: 'projects', label: 'Proyectos', icon: <ProjectIcon /> },
                { id: 'notes', label: 'Anotaciones', icon: <NoteIcon /> },
                { id: 'study', label: 'Estudio', icon: <ChartBarIcon /> }, // Ícono cambiado
              ].map(item => (
                <button
                  key={item.id}
                  onClick={() => setView(item.id)}
                  className={`flex-grow flex sm:flex-none items-center justify-center p-3 font-medium rounded-md transition-colors ${
                    view === item.id 
                      ? 'bg-blue-600 text-white shadow-md' 
                      : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                  }`}
                >
                  {item.icon}
                  <span className="ml-2 hidden sm:inline-block">{item.label}</span>
                </button>
              ))}
            </nav>
          </header>

          <main>
            {renderView()}
          </main>
          
          <Modal isOpen={isModalOpen} onClose={handleCloseModal}>
            {editingTask && (
              <EditTaskForm 
                task={editingTask}
                onUpdate={handleUpdateTask}
                onClose={handleCloseModal}
                onDelete={handleDeleteTask}
                projects={projects}
              />
            )}
          </Modal>
          
          <Modal isOpen={isPlannerOpen} onClose={() => setIsPlannerOpen(false)}>
            <StudyPlannerAI
              onClose={() => setIsPlannerOpen(false)}
              themes={studyThemes}
              onAddTheme={handleAddStudyTheme}
              onAddTasks={handleAddStudyTasks}
            />
          </Modal>

          {focusTask && (
            <TimerDisplay task={focusTask} onStop={handleStopTimer} />
          )}
          
        </div>
      );
    }

    ReactDOM.render(
      <ToastProvider>
        <App />
      </ToastProvider>,
      document.getElementById('root')
    );
  </script>
</body>
</html>
