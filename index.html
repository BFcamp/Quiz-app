<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Admin ¬∑ Google Sheets Sync (Upsert + Normalizaci√≥n)</title>
  <style>
    :root{--bg:#0b0c10;--panel:#11131a;--ink:#e6e6e6;--muted:#9aa3b2;--brand:#6ee7b7;--danger:#ff6b6b;--warn:#fbbf24}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:linear-gradient(180deg,#0b0c10,#0b0c10 40%,#0e1116 100%);color:var(--ink)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-weight:700;font-size:22px;margin:0 0 14px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:20px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:14px}
    .bar .spacer{flex:1}
    .status{font-size:12px;padding:6px 10px;border-radius:999px;background:#111827;color:#cbd5e1;border:1px solid #1f2937}
    .status.online{background:#052e1a;color:#d1fae5;border-color:#064e3b}
    .status.offline{background:#3b0d0d;color:#fecaca;border-color:#7f1d1d}
    .panel{background:var(--panel);border:1px solid #202433;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row-4{display:grid;grid-template-columns:1.2fr 1.2fr 2fr 1fr;gap:12px}
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #232838;background:#0d0f15;color:#e5e7eb;outline:none}
    textarea{min-height:80px}
    button{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:600;cursor:pointer;background:#1f2937;color:#e5e7eb;border:1px solid #334155;transition:transform .04s ease,opacity .2s}
    button:hover{opacity:.92}
    button:active{transform:translateY(1px)}
    .primary{background:#065f46;border-color:#0f766e}
    .warning{background:#4d2e00;border-color:#8a5a00}
    .danger{background:#5b1010;border-color:#991b1b}
    .ghost{background:transparent;border-color:#374151}
    .grid{overflow:auto;border-radius:12px;border:1px solid #1f2433}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:720px}
    thead th{position:sticky;top:0;background:#0f1320;color:#a8b3cf;text-align:left;font-weight:700;font-size:12px;border-bottom:1px solid #1f2433;padding:12px}
    tbody td{border-bottom:1px solid #161b27;padding:10px;font-size:14px;vertical-align:top}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px}
    .pill{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;background:#111827;border:1px solid #243042;color:#cbd5e1}
    .feedback{font-size:13px;margin-top:8px}
    .ok{color:var(--brand)}
    .bad{color:var(--danger)}
    .muted{color:var(--muted)}
    .nowrap{white-space:nowrap}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .soft{opacity:.8}
    @media (max-width:820px){.row-4{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Quiz Admin ¬∑ Google Sheets</h1>
    <div class="sub">Persistencia multi-dispositivo con <strong>upsert por <span class="mono">id</span></strong>, normalizaci√≥n de datos y re-lectura tras guardar.</div>

    <div class="bar">
      <button class="ghost" id="btn-refresh">üîÑ Refrescar (cloud ‚Üí app)</button>
      <button class="primary" id="btn-save">üíæ Guardar (app ‚Üí cloud)</button>
      <span class="spacer"></span>
      <span id="conn" class="status offline">offline</span>
    </div>

    <div class="panel">
      <div class="row-4">
        <div>
          <label>Materia</label>
          <input id="inp-materia" placeholder="p.ej., Toxicolog√≠a" />
        </div>
        <div>
          <label>Tema</label>
          <input id="inp-tema" placeholder="p.ej., Anticoagulantes" />
        </div>
        <div>
          <label>Pregunta</label>
          <input id="inp-pregunta" placeholder="Enunciado de la pregunta" />
        </div>
        <div>
          <label>√çndice correcto (0‚Äì3)</label>
          <input id="inp-correcta" type="number" min="0" max="9" value="0" />
        </div>    
      </div>
      <div class="row">
        <div>
          <label>Opciones (separadas por <span class="mono">|</span>)</label>
          <input id="inp-opciones" placeholder="Opci√≥n A | Opci√≥n B | Opci√≥n C | Opci√≥n D" />
        </div>
        <div class="flex" style="align-items:flex-end;justify-content:flex-end">
          <button id="btn-add" class="primary">‚ûï Agregar a la lista</button>
          <button id="btn-clear" class="ghost">üßπ Limpiar campos</button>
        </div>
      </div>
      <div id="feedback" class="feedback muted"></div>
    </div>

    <div class="panel">
      <div class="flex">
        <div class="soft">Preguntas en edici√≥n: <span id="count">0</span></div>
        <div class="right flex">
          <button id="btn-export" class="ghost">‚¨áÔ∏è Exportar JSON</button>
          <button id="btn-import" class="warning">‚¨ÜÔ∏è Importar JSON</button>
        </div>
      </div>
      <div class="grid" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th class="nowrap">Materia</th>
              <th class="nowrap">Tema</th>
              <th>Pregunta</th>
              <th>Opciones</th>
              <th class="nowrap">Correcta</th>
              <th class="nowrap">ID</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <details class="panel" open>
      <summary class="soft">Ajustes de conexi√≥n</summary>
      <div class="row">
        <div>
          <label>Google Apps Script Web App URL</label>
          <input id="inp-script" placeholder="https://script.google.com/macros/s/XXXX/exec" />
        </div>
        <div>
          <label>Filtro materia (opcional)</label>
          <input id="inp-filter-materia" placeholder="Dejar vac√≠o para traer todo" />
        </div>
      </div>
      <div class="soft" style="margin-top:10px">
        <p>El backend debe:</p>
        <ul>
          <li>Permitir <strong>GET</strong> para leer y <strong>POST</strong> para guardar.</li>
          <li>Hacer <strong>upsert</strong> por <span class="mono">id</span> (si existe, actualiza; si no, inserta).</li>
          <li>Responder <span class="mono">application/json</span> con <span class="mono">{ ok: true, data: [...] }</span>.</li>
          <li>Configurar despliegue: <em>Deploy &gt; Manage deployments</em> ‚Üí Execute as: <em>Me</em>; Who has access: <em>Anyone</em>.</li>
        </ul>
      </div>
    </details>
  </div>

  <script>
    // =============================
    // CONFIG
    // =============================
    const DEFAULT_SCRIPT_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiqa6L11JeWjMvctdSJLLKLRaSdr8G_CQRkORq6OeP1eBjaxF7CFDk-icTqNDgsp3qaPfZIzuid6wp_qdfqs6h2I-MfGn6djcIcrUWPDmGIi4d0tBQbQdp8bDkTzDuor1TFGkl4D8oRtwafbbPuI3dXiPJ4Yi8nBKotkc-TK3x-0yR569shWzotfy_Lmmgq1iPssOdJ2ex-dmzGDUy0jtIx09Z8VaBnrYhHaJWvigf5e4geMStRqBCN0yzvZ0G4atjYBa1SDel0EJNRfn5jxivk2e1C_5ND-4nIN1qX&lib=M0ouz-MrO7jH1KJF7KFs_uSae7Ado8u_k"; // üëà Pega aqu√≠ tu URL de Web App (Apps Script) o config√∫ralo abajo en el input.
    const STORAGE_KEY = "quiz-admin-config-v1";

    // =============================
    // ESTADO
    // =============================
    let SCRIPT_URL = DEFAULT_SCRIPT_URL;
    let allQuestions = [];            // estado local (tabla)
    let lastCloudSnapshot = [];       // copia de lo √∫ltimo le√≠do del servidor
    const clientId = (()=>"cli-"+Math.random().toString(36).slice(2,10))();

    // =============================
    // UTILIDADES
    // =============================
    function setFeedback(msg, ok=null){
      const el = document.getElementById('feedback');
      el.textContent = msg || '';
      el.classList.remove('ok','bad','muted');
      if (ok === true) el.classList.add('ok');
      else if (ok === false) el.classList.add('bad');
      else el.classList.add('muted');
    }
    function setConnectionState(state){
      const el = document.getElementById('conn');
      if(state==='online'){ el.textContent='online'; el.className='status online'; }
      else if(state==='connecting'){ el.textContent='conectando‚Ä¶'; el.className='status'; }
      else { el.textContent='offline'; el.className='status offline'; }
    }
    function saveLocalConfig(){
      const cfg = { SCRIPT_URL, filterMateria: document.getElementById('inp-filter-materia').value };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
    }
    function loadLocalConfig(){
      try{
        const cfg = JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");
        if(cfg){
          if(cfg.SCRIPT_URL) SCRIPT_URL = cfg.SCRIPT_URL;
          if(cfg.filterMateria) document.getElementById('inp-filter-materia').value = cfg.filterMateria;
          if(SCRIPT_URL) document.getElementById('inp-script').value = SCRIPT_URL;
        }
      }catch{}
    }

    function normalize(rawList){
      const arr = Array.isArray(rawList)? rawList : [];
      const out = [];
      let dropped = 0;
      for (const q of arr){
        if(!q){ dropped++; continue; }
        let opciones = q.opciones;
        if (typeof opciones === 'string'){
          try{ opciones = JSON.parse(opciones); }catch{ opciones = String(opciones).split('|').map(s=>s.trim()).filter(Boolean); }
        }
        const idx = Number(q.correctaindex);
        const norm = {
          id: (q.id ?? '').toString().trim(),
          materia: (q.materia ?? '').toString().trim(),
          tema: (q.tema ?? '').toString().trim(),
          pregunta: (q.pregunta ?? '').toString().trim(),
          opciones: Array.isArray(opciones) ? opciones : [],
          correctaindex: Number.isFinite(idx) ? idx : -1,
          _updatedAt: q._updatedAt ? String(q._updatedAt) : null,
          _clientId: q._clientId ? String(q._clientId) : null,
        };
        const ok = !!(norm.id && norm.materia && norm.tema && norm.pregunta && Array.isArray(norm.opciones) && norm.opciones.length>0 && Number.isInteger(norm.correctaindex) && norm.correctaindex>=0 && norm.correctaindex<norm.opciones.length);
        if(ok) out.push(norm); else dropped++;
      }
      if(dropped>0){ setFeedback(`Normalizaci√≥n: ${dropped} filas ignoradas por formato inv√°lido`, false); }
      return out;
    }

    function render(){
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      document.getElementById('count').textContent = String(allQuestions.length);
      for (const q of allQuestions){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="nowrap"><span class="pill">${escapeHtml(q.materia)}</span></td>
          <td class="nowrap">${escapeHtml(q.tema)}</td>
          <td>${escapeHtml(q.pregunta)}</td>
          <td class="mono">${q.opciones.map((o,i)=> i===q.correctaindex? `<strong>${escapeHtml(o)}</strong>` : escapeHtml(o)).join(' | ')}</td>
          <td class="nowrap">${q.correctaindex}</td>
          <td class="mono soft">${escapeHtml(q.id)}</td>
          <td class="nowrap">
            <button class="ghost" data-act="edit" data-id="${q.id}">‚úèÔ∏è</button>
            <button class="danger" data-act="del" data-id="${q.id}">üóëÔ∏è</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    function escapeHtml(s){
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function uiReadNew(){
      const materia = document.getElementById('inp-materia').value.trim();
      const tema = document.getElementById('inp-tema').value.trim();
      const pregunta = document.getElementById('inp-pregunta').value.trim();
      const opciones = document.getElementById('inp-opciones').value.split('|').map(s=>s.trim()).filter(Boolean);
      const correctaindex = Number(document.getElementById('inp-correcta').value);
      return {materia,tema,pregunta,opciones,correctaindex};
    }

    function clearInputs(){
      document.getElementById('inp-tema').value='';
      document.getElementById('inp-pregunta').value='';
      document.getElementById('inp-opciones').value='';
      document.getElementById('inp-correcta').value='0';
    }

    function upsertLocal(question){
      const idx = allQuestions.findIndex(x=>x.id===question.id);
      if(idx>=0) allQuestions[idx]=question; else allQuestions.push(question);
    }

    // =============================
    // NET: LECTURA Y ESCRITURA
    // =============================
    async function fetchFromCloud(){
      if(!SCRIPT_URL){ setFeedback('Configura la URL del Apps Script (abajo).', false); return []; }
      setConnectionState('connecting');
      try{
        const fMateria = document.getElementById('inp-filter-materia').value.trim();
        const url = new URL(SCRIPT_URL);
        if(fMateria) url.searchParams.set('materia', fMateria);
        url.searchParams.set('t', String(Date.now())); // cache bust
        const res = await fetch(url, { method:'GET', cache:'no-store' });
        const data = await res.json(); // { ok, data }
        if(!data || data.ok===false) throw new Error('Respuesta inv√°lida del servidor');
        const list = Array.isArray(data.data) ? data.data : (Array.isArray(data) ? data : []);
        lastCloudSnapshot = normalize(list);
        setConnectionState('online');
        return lastCloudSnapshot;
      }catch(err){
        console.error(err);
        setConnectionState('offline');
        setFeedback('No se pudo leer del servidor. Verifica despliegue/permiso CORS.', false);
        return [];
      }
    }

    async function saveToCloud(list){
      if(!SCRIPT_URL){ setFeedback('Configura la URL del Apps Script (abajo).', false); return false; }
      setConnectionState('connecting');
      try{
        const payload = { rows: list, clientId, ts: Date.now() };
        const res = await fetch(SCRIPT_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json(); // { ok, data }
        if(!data || data.ok!==true) throw new Error('El servidor no confirm√≥ el guardado');
        setConnectionState('online');
        return Array.isArray(data.data) ? data.data : list; // preferimos lo que devuelva el servidor
      }catch(err){
        console.error(err);
        setConnectionState('offline');
        setFeedback('Fallo al guardar en servidor. Revisa CORS/Apps Script.', false);
        return false;
      }
    }

    // =============================
    // EVENTOS UI
    // =============================
    document.getElementById('btn-add').addEventListener('click', ()=>{
      const q = uiReadNew();
      if(!q.materia || !q.tema || !q.pregunta || !q.opciones.length){ setFeedback('Completa materia, tema, pregunta y al menos 1 opci√≥n.', false); return; }
      if(!Number.isInteger(q.correctaindex) || q.correctaindex<0 || q.correctaindex>=q.opciones.length){ setFeedback('√çndice correcto inv√°lido.', false); return; }
      const id = Date.now().toString()+"-"+Math.random().toString(36).slice(2,8);
      const row = { id, ...q, _updatedAt: new Date().toISOString(), _clientId: clientId };
      upsertLocal(row);
      render();
      setFeedback('Agregada localmente. Recuerda guardar en la nube.', true);
      clearInputs();
    });

    document.getElementById('btn-clear').addEventListener('click', clearInputs);

    document.getElementById('tbody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      if(act==='del'){
        allQuestions = allQuestions.filter(q=>q.id!==id);
        render();
      } else if(act==='edit'){
        const q = allQuestions.find(x=>x.id===id);
        if(!q) return;
        document.getElementById('inp-materia').value = q.materia;
        document.getElementById('inp-tema').value = q.tema;
        document.getElementById('inp-pregunta').value = q.pregunta;
        document.getElementById('inp-opciones').value = q.opciones.join(' | ');
        document.getElementById('inp-correcta').value = String(q.correctaindex);
        // mantener mismo id en edici√≥n: lo removemos y al presionar Agregar se crea un nuevo id.
        allQuestions = allQuestions.filter(x=>x.id!==id);
        render();
        setFeedback('Editando: actualiza y vuelve a agregar.', null);
      }
    });

    document.getElementById('btn-refresh').addEventListener('click', async()=>{
      setFeedback('Leyendo desde la nube‚Ä¶');
      const cloud = await fetchFromCloud();
      if(cloud.length){ allQuestions = cloud.slice(); render(); setFeedback('Sincronizado (cloud ‚Üí app).', true); }
    });

    document.getElementById('btn-save').addEventListener('click', async()=>{
      if(!allQuestions.length){ setFeedback('No hay nada para guardar.', false); return; }
      setFeedback('Guardando‚Ä¶');
      const serverData = await saveToCloud(allQuestions);
      if(serverData===false) return; // error
      // Re-lectura para fuente de verdad
      const cloud = await fetchFromCloud();
      if(cloud.length){ allQuestions = cloud.slice(); render(); setFeedback('Guardado y re-le√≠do desde la nube (app ‚áÑ cloud).', true); }
    });

    document.getElementById('btn-export').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(allQuestions, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'preguntas.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('btn-import').addEventListener('click', ()=>{
      const inp = document.createElement('input');
      inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = ()=>{
        const file = inp.files?.[0]; if(!file) return;
        const fr = new FileReader();
        fr.onload = ()=>{
          try{
            const data = JSON.parse(String(fr.result||'[]'));
            const norm = normalize(data);
            allQuestions = norm;
            render();
            setFeedback(`Importadas ${norm.length} preguntas.`, true);
          }catch(err){ setFeedback('JSON inv√°lido.', false); }
        };
        fr.readAsText(file);
      };
      inp.click();
    });

    document.getElementById('inp-script').addEventListener('change', (e)=>{
      SCRIPT_URL = e.target.value.trim(); saveLocalConfig();
    });
    document.getElementById('inp-filter-materia').addEventListener('change', saveLocalConfig);

    // =============================
    // INICIO
    // =============================
    (async function init(){
      loadLocalConfig();
      if(!SCRIPT_URL){ setFeedback('Pega la URL de tu Apps Script Web App debajo y presiona ‚ÄúRefrescar‚Äù.', null); return; }
      setFeedback('Inicializando‚Ä¶');
      const cloud = await fetchFromCloud();
      allQuestions = cloud.length? cloud.slice() : [];
      render();
      if(cloud.length){ setFeedback('Listo. Datos cargados desde la nube.', true); }
    })();
  </script>
</body>
</html>

