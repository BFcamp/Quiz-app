<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo personalizado para las opciones de respuesta */
        .opcion-btn {
            transition: all 0.2s;
        }
        /* Clase para la respuesta seleccionada/no revisada */
        .opcion-btn:not(.correcto):not(.incorrecto):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Clases de estado dinámico */
        .seleccionada {
            border: 3px solid #6366f1; /* Indigo */
        }
        .correcta {
            background-color: #10b981 !important; /* Esmeralda 500 */
            color: white !important;
            border-color: #059669 !important;
        }
        .incorrecto {
            background-color: #ef4444 !important; /* Rojo 500 */
            color: white !important;
            border-color: #dc2626 !important;
        }
        .hidden-transition {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.3s ease-out, max-height 0.3s ease-out;
        }
        .visible-transition {
            opacity: 1;
            max-height: 500px; /* Suficiente para mostrar el contenido */
        }
        /* Spinner CSS */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para el modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4" style="font-family: 'Inter', sans-serif;">

    <div id="app" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-10">

        <!-- Encabezado -->
        <header class="text-center mb-6">
            <h1 id="app-title" class="text-3xl font-extrabold text-indigo-700">Quiz App</h1>
        </header>

        <!-- Pantalla de Carga de Firebase -->
        <div id="loading-screen" class="text-center p-10 bg-indigo-50 rounded-xl">
            <div class="spinner mx-auto mb-4"></div>
            <p id="loading-message" class="text-lg font-medium text-indigo-700">Iniciando aplicación y autenticando...</p>
        </div>

        <!-- Pantalla de Selección de Materia -->
        <div id="materia-selection-container" class="hidden text-center p-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona una Materia</h2>
            <div id="materia-buttons" class="space-y-4 max-w-sm mx-auto">
                <!-- Botones se inyectarán aquí -->
            </div>
        </div>

        <!-- Pantalla de Selección de Tema -->
        <div id="tema-selection-container" class="hidden text-center p-10">
            <button id="btn-volver-materia"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm mb-6">
                ← Volver a Materias
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona un Tema para <span id="current-materia-name"></span></h2>
            <div id="tema-buttons" class="space-y-4 max-w-sm mx-auto">
                <!-- Botones se inyectarán aquí (o el mensaje de carga) -->
            </div>
            <p id="no-temas-message" class="text-gray-500 mt-6 hidden">No hay temas guardados. Ve al editor para cargar preguntas.</p>
        </div>


        <!-- Botón de Alternancia de Vista (visible solo en quiz-container) -->
        <div class="mb-6 flex justify-between hidden" id="quiz-header-buttons">
             <button id="btn-cambiar-materia"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                Cambiar Materia
            </button>
             <button id="btn-alternar-vista"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                Mostrar Editor
            </button>
        </div>

        <!-- Contenedor del Editor de Preguntas (Panel de Gestión) -->
        <div id="editor-container" class="hidden">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4">Panel de Gestión (<span id="editor-materia-nombre">Materia</span>)</h2>
            
            <!-- ✨ SECCIÓN: GENERACIÓN DE PREGUNTAS CON IA ✨ -->
            <div class="p-4 border-2 border-dashed border-indigo-300 rounded-lg mb-6 bg-indigo-50">
                 <h3 class="text-xl font-bold text-indigo-700 mb-3">✨ Generador de Preguntas con IA</h3>
                 <p class="text-sm text-gray-600 mb-3">¿Necesitas preguntas para un tema nuevo? Escríbelo aquí y la IA creará 3 preguntas para ti.</p>
                 <div class="flex space-x-2">
                     <input type="text" id="ia-generate-topic-input" placeholder="Ej: Intoxicación por Plomo" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500">
                     <button id="btn-ia-generate" class="py-3 px-5 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition flex items-center justify-center disabled:bg-gray-400">
                        <span id="ia-generate-text">Generar</span>
                        <div id="ia-generate-spinner" class="spinner ml-2 hidden"></div>
                     </button>
                 </div>
            </div>
            
            <!-- Botón de Alternancia a Carga Masiva -->
            <button id="btn-toggle-carga-masiva" class="w-full py-2 mb-4 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition">
                Mostrar/Ocultar Carga Masiva de Texto
            </button>

            <!-- Contenedor de Carga Masiva (Inicialmente oculto) -->
            <div id="carga-masiva-container" class="p-4 border border-gray-200 rounded-lg mb-6 hidden">
                <h3 class="text-lg font-bold text-gray-700 mb-3">Carga Masiva desde Texto</h3>
                <div class="mb-4">
                     <label for="tema-input" class="block text-sm font-medium text-gray-700 mb-1">Tema a Asignar (Obligatorio)</label>
                     <input type="text" id="tema-input" placeholder="Escribe un tema para estas preguntas" 
                            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <textarea id="texto-pdf" rows="6" placeholder="Pega aquí el texto sin formato de tus preguntas (Ej: 'Pregunta 1. ¿Antídoto...? a) Opción b) Correcta c) Opción... JUSTIFICACIÓN: ...') "
                          class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 mb-4"></textarea>

                <button id="btn-analizar"
                        class="w-full py-3 px-6 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <span id="analizar-text">Analizar y Cargar Preguntas</span>
                        <div id="analizar-spinner" class="spinner ml-3 hidden"></div>
                </button>
                <p class="text-gray-500 text-xs mt-2 text-center">Esta función usa IA para estructurar el texto. Puede fallar con textos muy complejos.</p>
            </div>


            <div id="editor-feedback" class="mb-4 p-3 rounded-lg text-sm hidden"></div>

            <!-- Panel de Gestión de Preguntas -->
            <h3 class="text-xl font-bold text-gray-700 my-4 border-t pt-4">Preguntas Guardadas (<span id="total-preguntas-editor">0</span>)</h3>
            <div id="gestion-preguntas-container" class="space-y-3">
                 <!-- Las preguntas guardadas se listarán aquí por tema -->
            </div>

        </div>

        <!-- Contenedor del Cuestionario (Inicialmente oculto) -->
        <div id="quiz-container" class="hidden">
             <div class="flex justify-between items-center mt-2 mb-4">
                 <p class="text-sm font-semibold text-indigo-700">Tema Actual: <span id="current-tema-name" class="text-indigo-900 font-bold"></span></p>
                 <div id="puntaje-container" class="text-xl font-semibold text-gray-700">
                    Puntaje: <span id="puntaje">0</span> / <span id="total-preguntas">0</span>
                </div>
            </div>
            <!-- Área de la Pregunta -->
            <div class="bg-indigo-50 p-6 rounded-lg shadow-inner mb-6 transition-all duration-300">
                <div class="flex justify-between items-start">
                    <div>
                        <p id="contador-pregunta" class="text-sm font-medium text-indigo-500 mb-2"></p>
                        <h2 id="pregunta-texto" class="text-xl font-bold text-gray-800">Cargando pregunta...</h2>
                    </div>
                     <!-- ✨ BOTÓN: PISTA ✨ -->
                    <button id="btn-pista" class="py-2 px-4 bg-yellow-400 text-yellow-900 text-sm font-semibold rounded-full hover:bg-yellow-500 transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">Pista ✨</button>
                </div>
                 <!-- Contenedor para la Pista de la IA -->
                 <div id="pista-container" class="mt-3 p-3 bg-yellow-100 text-yellow-800 text-sm rounded-lg border border-yellow-300 hidden"></div>
            </div>

            <!-- Área de Opciones -->
            <div id="opciones-container" class="space-y-4">
                <!-- Las opciones se inyectarán aquí por JavaScript -->
            </div>

            <!-- Área de Retroalimentación/Mensaje -->
            <div id="feedback-container" class="mt-6 hidden-transition">
                <p id="feedback-texto" class="p-3 rounded-lg text-center font-bold"></p>
                <div id="justificacion-box" class="mt-4 p-4 bg-gray-100 rounded-lg border border-gray-300 text-gray-700 text-sm hidden">
                    <div class="flex justify-between items-start">
                        <div>
                             <p class="font-bold text-indigo-600 mb-1">Justificación:</p>
                             <p id="justificacion-texto"></p>
                        </div>
                        <div class="flex flex-col space-y-2 ml-4 flex-shrink-0">
                            <button id="btn-eli5" class="py-1 px-3 text-xs bg-teal-400 text-teal-900 font-semibold rounded-full hover:bg-teal-500 transition shadow-sm">Explícamelo Fácil ✨</button>
                            <button id="btn-verify-quiz" class="py-1 px-3 text-xs bg-yellow-400 text-yellow-900 font-semibold rounded-full hover:bg-yellow-500 transition shadow-sm" style="display: none;">Verificar con IA ✨</button>
                        </div>
                    </div>
                    <!-- Contenedor para la explicación fácil de la IA -->
                    <div id="eli5-container" class="mt-3 pt-3 border-t border-gray-300 text-sm text-teal-800 hidden"></div>
                    <div id="verify-quiz-feedback" class="mt-2 text-xs text-center font-medium"></div>
                </div>
            </div>

            <!-- Botón de Acción -->
            <div class="mt-8 flex justify-center">
                <button id="btn-siguiente" disabled
                        class="w-full py-3 px-6 bg-gray-300 text-gray-700 font-bold rounded-lg shadow-md hover:bg-gray-400 transition duration-150 ease-in-out disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Siguiente Pregunta
                </button>
            </div>
        </div>

        <!-- Pantalla de Resultados Finales -->
        <div id="resultados-container" class="text-center p-10 hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4">¡Cuestionario Terminado!</h2>
            <p class="text-xl text-gray-600 mb-6">Tu puntaje final es:</p>
            <p id="resultado-final" class="text-6xl font-extrabold text-green-600 mb-8">0/0</p>
            <button id="btn-reiniciar"
                    class="py-3 px-8 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 ease-in-out">
                Volver a Empezar
            </button>
        </div>
        
        <!-- MODAL DE EDICIÓN (Inicialmente oculto) -->
        <div id="edit-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="text-2xl font-bold text-indigo-600 mb-4">Editar Pregunta</h3>
                <div class="space-y-4">
                    <input type="hidden" id="edit-question-index">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pregunta:</label>
                        <textarea id="edit-pregunta" rows="3" class="w-full p-2 border rounded-lg"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tema:</label>
                        <input type="text" id="edit-tema" class="w-full p-2 border rounded-lg" readonly>
                    </div>

                    <div id="edit-opciones-container">
                        <label class="block text-sm font-medium text-gray-700">Opciones (Marca Correcta en el selector):</label>
                        <!-- Opciones se inyectarán aquí -->
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Índice Correcto (0, 1, 2, 3):</label>
                        <select id="edit-correcta-index" class="w-full p-2 border rounded-lg">
                            <option value="0">Opción 1</option>
                            <option value="1">Opción 2</option>
                            <option value="2">Opción 3</option>
                            <option value="3">Opción 4</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Justificación:</label>
                        <textarea id="edit-justificacion" rows="4" class="w-full p-2 border rounded-lg"></textarea>
                    </div>
                </div>

                <div id="edit-feedback" class="mt-4 p-3 rounded-lg text-sm hidden"></div>

                <div class="flex justify-between mt-6 space-x-3">
                    <button id="btn-verify-ia" class="flex-1 py-2 px-4 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition disabled:bg-gray-400">
                        ✨ Verificar con IA
                    </button>
                    <button id="btn-save-edit" class="flex-1 py-2 px-4 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
                        Guardar Cambios
                    </button>
                    <button id="btn-cancel-edit" class="py-2 px-4 bg-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-400 transition">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIABLES GLOBALES DE FIREBASE ---
        let app;
        let db;
        let auth;
        let userId;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // --- CONFIGURACIÓN DE FIREBASE ---
        // CLAVES DE CONFIGURACIÓN PROPORCIONADAS POR EL USUARIO
        const firebaseConfig = {
            apiKey: "AIzaSyBaitrYn2XZvUrHzLOOPOzbyFs_1c4HXvs",
            authDomain: "quiz-d8af5.firebaseapp.com",
            projectId: "quiz-d8af5",
            storageBucket: "quiz-d8af5.firebasestorage.app",
            messagingSenderId: "599443214955",
            appId: "1:599443214955:web:56e22bf9dceb71f24d972e",
            measurementId: "G-QV9XDSWCVH"
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const LOCAL_STORAGE_KEY_PREFIX = 'quiz_data_local_';

        // --- CONFIGURACIÓN DE MATERIAS ---
        const MATERIAS = {
            'toxicologia': { name: 'Toxicología', color: 'bg-indigo-600', hover: 'hover:bg-indigo-700', defaultQuestions: [
                { pregunta: "¿Cuál es el principal antídoto para el paracetamol?", opciones: ["Flumazenil", "N-acetilcisteína (NAC)", "Atropina", "Naloxona"], correctaIndex: 1, justificacion: "El NAC (N-acetilcisteína) es el precursor de glutatión, el cual es esencial para detoxificar el metabolito tóxico del paracetamol (NAPQI).", tema: "Antídotos Clave" },
                { pregunta: "¿El cianuro inhibe qué complejo de la cadena respiratoria?", opciones: ["Complejo I", "Complejo II", "Complejo III", "Complejo IV"], correctaIndex: 3, justificacion: "El cianuro inhibe irreversiblemente el Complejo IV (Citocromo c oxidasa), bloqueando la respiración celular y causando hipoxia histotóxica.", tema: "Mecanismos de Toxicidad" }
            ]},
            'oftalmologia': { name: 'Oftalmología', color: 'bg-teal-600', hover: 'hover:bg-teal-700', defaultQuestions: [
                { pregunta: "¿Qué estructura es responsable de la visión central más nítida?", opciones: ["Retina periférica", "Mácula", "Nervio óptico", "Cristalino"], correctaIndex: 1, justificacion: "La mácula, especialmente la fóvea en su centro, contiene la mayor concentración de fotorreceptores (conos) y es la encargada de la visión fina y de color.", tema: "Anatomía del Ojo"},
                { pregunta: "¿El glaucoma suele estar asociado con un daño al?", opciones: ["Iris", "Nervio óptico", "Córnea", "Conjuntiva"], correctaIndex: 1, justificacion: "El glaucoma es una neuropatía óptica progresiva, caracterizada por la pérdida de fibras nerviosas en el nervio óptico, generalmente relacionada con una presión intraocular elevada.", tema: "Patologías Comunes" }
            ]}
        };
        
        // --- VARIABLES DE ESTADO DE LA APLICACIÓN ---
        let preguntasMateriaCompleta = []; // Almacena TODAS las preguntas cargadas para la materia
        let preguntas = []; // Almacena las preguntas FILTRADAS por tema
        let currentMateria = null; 
        let currentTema = null; 
        let indicePreguntaActual = 0;
        let puntaje = 0;
        let seleccionActual = null;
        let respuestaComprobada = false;
        let vistaActual = 'quiz'; 
        let unsubscribeFromQuiz = null; 
        let firebaseInitialized = false;

        // --- REFERENCIAS DEL DOM ---
        const appTitle = document.getElementById('app-title');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingMessage = document.getElementById('loading-message');
        const materiaSelectionContainer = document.getElementById('materia-selection-container');
        const materiaButtons = document.getElementById('materia-buttons');
        const temaSelectionContainer = document.getElementById('tema-selection-container');
        const temaButtons = document.getElementById('tema-buttons');
        const currentMateriaName = document.getElementById('current-materia-name');
        const noTemasMessage = document.getElementById('no-temas-message');
        const quizContainer = document.getElementById('quiz-container');
        const resultadosContainer = document.getElementById('resultados-container');
        const preguntaTexto = document.getElementById('pregunta-texto');
        const opcionesContainer = document.getElementById('opciones-container');
        const contadorPregunta = document.getElementById('contador-pregunta');
        const puntajeSpan = document.getElementById('puntaje');
        const totalPreguntasSpan = document.getElementById('total-preguntas');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackTexto = document.getElementById('feedback-texto');
        const justificacionBox = document.getElementById('justificacion-box');
        const justificacionTexto = document.getElementById('justificacion-texto');
        const btnSiguiente = document.getElementById('btn-siguiente');
        const btnReiniciar = document.getElementById('btn-reiniciar');
        const resultadoFinal = document.getElementById('resultado-final');
        const editorContainer = document.getElementById('editor-container');
        const btnAlternarVista = document.getElementById('btn-alternar-vista');
        const btnCambiarMateria = document.getElementById('btn-cambiar-materia');
        const btnVolverMateria = document.getElementById('btn-volver-materia');
        const quizHeaderButtons = document.getElementById('quiz-header-buttons');
        const editorMateriaNombre = document.getElementById('editor-materia-nombre');
        const editorFeedback = document.getElementById('editor-feedback');
        const currentTemaName = document.getElementById('current-tema-name');
        const totalPreguntasEditor = document.getElementById('total-preguntas-editor');
        const gestionPreguntasContainer = document.getElementById('gestion-preguntas-container');
        
        // Referencias para el Modal
        const editModalOverlay = document.getElementById('edit-modal-overlay');
        const editPregunta = document.getElementById('edit-pregunta');
        const editTema = document.getElementById('edit-tema');
        const editOpcionesContainer = document.getElementById('edit-opciones-container');
        const editCorrectaIndex = document.getElementById('edit-correcta-index');
        const editJustificacion = document.getElementById('edit-justificacion');
        const editQuestionIndex = document.getElementById('edit-question-index');
        const btnSaveEdit = document.getElementById('btn-save-edit');
        const btnCancelEdit = document.getElementById('btn-cancel-edit');
        const btnVerifyIa = document.getElementById('btn-verify-ia');
        const editFeedback = document.getElementById('edit-feedback');

        // ✨ Referencias para las nuevas funciones de IA ✨
        const btnPista = document.getElementById('btn-pista');
        const pistaContainer = document.getElementById('pista-container');
        const btnEli5 = document.getElementById('btn-eli5');
        const eli5Container = document.getElementById('eli5-container');
        const btnIaGenerate = document.getElementById('btn-ia-generate');
        const iaGenerateTopicInput = document.getElementById('ia-generate-topic-input');
        const iaGenerateSpinner = document.getElementById('ia-generate-spinner');
        const iaGenerateText = document.getElementById('ia-generate-text');
        const btnVerifyQuiz = document.getElementById('btn-verify-quiz');
        const verifyQuizFeedback = document.getElementById('verify-quiz-feedback');


        // Referencias para Carga Masiva (reincorporado)
        const btnToggleCargaMasiva = document.getElementById('btn-toggle-carga-masiva');
        const cargaMasivaContainer = document.getElementById('carga-masiva-container');
        const temaInput = document.getElementById('tema-input');
        const textoPdf = document.getElementById('texto-pdf');
        const btnAnalizar = document.getElementById('btn-analizar');
        const analizarText = document.getElementById('analizar-text');
        const analizarSpinner = document.getElementById('analizar-spinner');


        // --- FIREBASE Y PERSISTENCIA DE DATOS ---

        // Función de guardado local
        function saveLocalQuestions(materiaId, questions) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY_PREFIX + materiaId, JSON.stringify(questions));
                console.log(`Guardado local exitoso para ${materiaId}`);
            } catch (e) {
                console.error("Error al guardar en localStorage:", e);
            }
        }

        // Función de carga local
        function loadLocalQuestions(materiaId) {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY_PREFIX + materiaId);
                if (data) {
                    const savedQuestions = JSON.parse(data);
                    if (Array.isArray(savedQuestions)) {
                         console.log(`Carga local exitosa para ${materiaId}. Preguntas: ${savedQuestions.length}`);
                        return savedQuestions;
                    }
                }
            } catch (e) {
                console.error("Error al cargar de localStorage:", e);
            }
            return null;
        }

        async function initFirebase() {
            loadingScreen.classList.remove('hidden');
            
            // Si falta el projectId, asumimos que la configuración es inválida.
            if (!firebaseConfig || !firebaseConfig.projectId) {
                loadingMessage.textContent = "Advertencia: La persistencia de datos está deshabilitada (configuración faltante).";
                console.warn("Firebase config is missing or incomplete. Data persistence disabled.");
                firebaseInitialized = false;
                setTimeout(() => showMateriaSelection(), 2000);
                return;
            }
            
            // Intentamos inicializar con la configuración proporcionada
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); 
            firebaseInitialized = true; // Marcamos que la inicialización básica ocurrió

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase Auth successful. User ID:", userId);
                
            } catch (error) {
                // Capturamos cualquier error real de Firebase (p. ej., clave API inválida o auth/configuration-not-found)
                console.error("Firebase Auth or Initialization Error:", error);
                
                // Si la autenticación falla, usamos un ID temporal y alertamos al usuario
                userId = crypto.randomUUID(); 
                firebaseInitialized = false; // Deshabilitamos la interacción con Firestore
                
                let errorMessage = "Error: La autenticación falló. Las preguntas NO se guardarán en la nube. Usando guardado LOCAL.";
                
                if (error.code === 'auth/configuration-not-found') {
                    errorMessage = "⛔ ERROR CRÍTICO (AUTH) ⛔: La persistencia de datos falló. Habilita 'Authentication' (proveedor Anónimo) en la consola de Firebase. Usando guardado LOCAL.";
                } else {
                    errorMessage = "Error de conexión a la nube. Usando guardado LOCAL. Revisa tus reglas de seguridad.";
                }
                
                loadingMessage.textContent = errorMessage;
                // Dejamos un delay para que el usuario pueda leer el mensaje de error antes de continuar
                setTimeout(() => showMateriaSelection(), 4000); 
                return;
            }
            
            // Si la autenticación fue exitosa o si se saltó el error (en caso de que el timeout no se haya ejecutado),
            // llamamos a showMateriaSelection aquí.
            showMateriaSelection();
        }

        function getQuizDocRef(materiaId) {
            if (!db || !userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, 'quiz_data', materiaId);
        }
        
        function loadFullQuestionsList() {
            if (!currentMateria) return;
            
            if (unsubscribeFromQuiz) {
                unsubscribeFromQuiz();
                unsubscribeFromQuiz = null;
            }

            const materiaConfig = MATERIAS[currentMateria];
            let questionsLoaded = false;
            let isInitialLoad = true;
            
            // 1. Intento de carga desde Firestore (solo si Firebase está inicializado)
            if (firebaseInitialized) {
                const quizDocRef = getQuizDocRef(currentMateria);
                if (quizDocRef) {
                    unsubscribeFromQuiz = onSnapshot(quizDocRef, (docSnap) => {
                        let firebaseDataFound = false;
                        if (docSnap.exists() && docSnap.data().questions) {
                            try {
                                const savedQuestions = JSON.parse(docSnap.data().questions);
                                if (Array.isArray(savedQuestions) && savedQuestions.length > 0) {
                                     preguntasMateriaCompleta = savedQuestions;
                                     firebaseDataFound = true;
                                     console.log(`Cargadas ${savedQuestions.length} preguntas desde Firestore.`);
                                }
                            } catch (e) {
                                console.error("Error al parsear preguntas guardadas desde Firestore:", e);
                            }
                        }
                        
                        // 2. Si Firestore falla o está vacío, cargamos localmente
                        if (!firebaseDataFound) {
                            const localData = loadLocalQuestions(currentMateria);
                            if (localData && localData.length > 0) {
                                preguntasMateriaCompleta = localData;
                            } else {
                                preguntasMateriaCompleta = materiaConfig.defaultQuestions;
                            }
                        }

                        renderGestionPreguntas(); 
                        if (isInitialLoad) {
                            showTemaSelection();
                            isInitialLoad = false;
                        }

                    }, (error) => {
                        console.error("Error al suscribirse a Firestore (cargando localmente):", error);
                        // Fallback a Local Storage si la suscripción falla
                        const localData = loadLocalQuestions(currentMateria);
                        if (localData && localData.length > 0) {
                            preguntasMateriaCompleta = localData;
                        } else {
                            preguntasMateriaCompleta = materiaConfig.defaultQuestions;
                        }
                        renderGestionPreguntas();
                        if (isInitialLoad) {
                            showTemaSelection();
                            isInitialLoad = false;
                        }
                    });
                    return; // Terminamos la función para esperar el onSnapshot
                }
            } 
            
            // 3. Carga local si Firebase no está inicializado o el docRef es nulo
            const localData = loadLocalQuestions(currentMateria);
            if (localData && localData.length > 0) {
                preguntasMateriaCompleta = localData;
            } else {
                preguntasMateriaCompleta = materiaConfig.defaultQuestions;
            }
            
            renderGestionPreguntas(); 
            showTemaSelection();
        }
        
        async function saveAllQuestionsToFirestore(questionsList) {
             const materiaId = currentMateria;

             // Guardado Local (Prioridad 2)
             saveLocalQuestions(materiaId, questionsList);

             // Guardado en Firestore (Prioridad 1)
             if (!firebaseInitialized || !db || !userId || !materiaId) {
                // Si Firebase no está listo o falló, solo guardamos localmente y retornamos true
                setFeedback(`Guardado solo localmente. ${!firebaseInitialized ? 'La nube está deshabilitada.' : 'Error de conexión.'}`, false);
                return true;
            }
             try {
                const quizDocRef = getQuizDocRef(materiaId);
                await setDoc(quizDocRef, {
                    questions: JSON.stringify(questionsList), 
                    lastUpdated: serverTimestamp() 
                }, { merge: false });
                console.log(`Preguntas guardadas con éxito en Firestore para la materia: ${materiaId}. Total: ${questionsList.length}`);
                return true;
            } catch (error) {
                console.error("Error al guardar preguntas en Firestore:", error);
                // Mensaje mejorado para el usuario sobre el error más común
                setFeedback("Advertencia: El guardado en la nube falló. Los datos están guardados localmente.", true);
                return false;
            }
        }

        // --- FUNCIONES DE GESTIÓN (EDITAR/ELIMINAR) ---
        
        function renderGestionPreguntas() {
            gestionPreguntasContainer.innerHTML = '';
            totalPreguntasEditor.textContent = preguntasMateriaCompleta.length;

            if (preguntasMateriaCompleta.length === 0) {
                gestionPreguntasContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Aún no hay preguntas guardadas para esta materia.</p>';
                return;
            }

            const preguntasPorTema = preguntasMateriaCompleta.reduce((acc, q, index) => {
                const tema = q.tema || 'Sin Tema';
                if (!acc[tema]) acc[tema] = [];
                acc[tema].push({ ...q, originalIndex: index }); 
                return acc;
            }, {});

            let uniqueIdCounter = 0; 

            Object.entries(preguntasPorTema).sort(([a], [b]) => a.localeCompare(b)).forEach(([tema, listaPreguntas]) => {
                const collapseId = `tema-collapse-${uniqueIdCounter++}`;
                
                const temaHeader = document.createElement('button');
                temaHeader.classList.add('flex', 'justify-between', 'items-center', 'w-full', 'p-3', 'bg-gray-100', 'text-gray-700', 'font-semibold', 'rounded-lg', 'hover:bg-gray-200', 'transition');
                temaHeader.innerHTML = `
                    <span>${tema} (${listaPreguntas.length} preguntas)</span>
                    <span id="icon-${collapseId}" class="transform transition duration-300">▼</span>
                `;
                temaHeader.setAttribute('data-target', collapseId);
                gestionPreguntasContainer.appendChild(temaHeader);

                const temaBody = document.createElement('div');
                temaBody.id = collapseId;
                temaBody.classList.add('p-3', 'border-t', 'border-gray-200', 'space-y-3', 'hidden');
                gestionPreguntasContainer.appendChild(temaBody);
                
                temaHeader.addEventListener('click', () => {
                    const isHidden = temaBody.classList.toggle('hidden');
                    document.getElementById(`icon-${collapseId}`).style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
                });

                listaPreguntas.forEach((q, index) => {
                    const qElement = document.createElement('div');
                    qElement.classList.add('p-3', 'bg-white', 'border', 'rounded-lg', 'shadow-sm');
                    qElement.innerHTML = `
                        <p class="text-sm font-bold text-indigo-700 mb-2">${index + 1}. ${q.pregunta}</p>
                        <p class="text-xs text-gray-600 mb-2">Respuesta: ${q.opciones[q.correctaIndex]} </p>
                        <div class="flex space-x-2 justify-end">
                            <button data-index="${q.originalIndex}" class="btn-editar py-1 px-3 text-xs bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition">Editar</button>
                            <button data-index="${q.originalIndex}" class="btn-eliminar py-1 px-3 text-xs bg-red-500 text-white rounded-md hover:bg-red-600 transition">Eliminar</button>
                        </div>
                    `;
                    temaBody.appendChild(qElement);
                });
            });
            
            document.querySelectorAll('.btn-editar').forEach(btn => btn.addEventListener('click', openEditModal));
            document.querySelectorAll('.btn-eliminar').forEach(btn => btn.addEventListener('click', deleteQuestion));
        }

        function openEditModal(event) {
            const index = parseInt(event.target.dataset.index);
            const question = preguntasMateriaCompleta[index];

            if (!question) {
                setFeedback("Error: Pregunta no encontrada para edición.", true);
                return;
            }
            
            editQuestionIndex.value = index;
            editPregunta.value = question.pregunta;
            editTema.value = question.tema || 'Sin Tema';
            editCorrectaIndex.value = question.correctaIndex;
            editJustificacion.value = question.justificacion || '';
            
            editOpcionesContainer.innerHTML = '';
            question.opciones.forEach((opcion, i) => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'space-x-2', 'mb-2');
                div.innerHTML = `
                    <span class="w-10 text-right text-sm font-medium text-gray-500">Opción ${i + 1}:</span>
                    <input type="text" id="edit-opcion-${i}" value="${opcion}" class="flex-grow p-2 border rounded-lg edit-opcion-input">
                `;
                editOpcionesContainer.appendChild(div);
            });
            
            editFeedback.classList.add('hidden');
            editModalOverlay.classList.remove('hidden');
        }

        async function saveEditChanges() {
            const index = parseInt(editQuestionIndex.value);

            if (isNaN(index) || index < 0 || index >= preguntasMateriaCompleta.length) {
                setEditFeedback("Error: Índice de pregunta no válido.", true);
                return;
            }

            const newOpciones = [];
            const opcionInputs = document.querySelectorAll('.edit-opcion-input');
            opcionInputs.forEach(input => newOpciones.push(input.value.trim()));
            
            const updatedQuestion = {
                pregunta: editPregunta.value.trim(),
                opciones: newOpciones,
                correctaIndex: parseInt(editCorrectaIndex.value),
                justificacion: editJustificacion.value.trim(),
                tema: editTema.value.trim()
            };

            if (updatedQuestion.pregunta.length < 5) {
                setEditFeedback("La pregunta no puede estar vacía.", true);
                return;
            }
            if (updatedQuestion.correctaIndex < 0 || updatedQuestion.correctaIndex >= updatedQuestion.opciones.length) {
                setEditFeedback("El índice correcto no es válido.", true);
                return;
            }
            
            const updatedList = [...preguntasMateriaCompleta];
            updatedList[index] = updatedQuestion;

            const success = await saveAllQuestionsToFirestore(updatedList);
            
            if (success) {
                setFeedback(`¡Éxito! La pregunta del tema "${updatedQuestion.tema}" fue actualizada.`, false);
                editModalOverlay.classList.add('hidden');
            } else {
                 setEditFeedback("Error al guardar los cambios en la base de datos.", true);
            }
        }

        async function deleteQuestion(event) {
            const index = parseInt(event.target.dataset.index);
            
            if (!confirm("¿Estás seguro de que quieres eliminar esta pregunta?")) return;

            if (isNaN(index) || index < 0 || index >= preguntasMateriaCompleta.length) {
                setFeedback("Error: Índice de pregunta no válido para eliminar.", true);
                return;
            }

            const updatedList = preguntasMateriaCompleta.filter((_, i) => i !== index);
            const success = await saveAllQuestionsToFirestore(updatedList);
            
            if (success) {
                setFeedback(`¡Éxito! Se eliminó la pregunta de la lista.`, false);
            } else {
                 setFeedback("Error al eliminar la pregunta de la base de datos.", true);
            }
        }
        
        function setEditFeedback(message, isError = false) {
             editFeedback.textContent = message;
             editFeedback.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
             if (isError) {
                 editFeedback.classList.add('bg-red-100', 'text-red-700');
             } else {
                 editFeedback.classList.add('bg-green-100', 'text-green-700');
             }
        }
        
        // --- FUNCIONES DE UTILIDAD PARA VISTAS ---

        function showMateriaSelection() {
            loadingScreen.classList.add('hidden');
            quizContainer.classList.add('hidden');
            editorContainer.classList.add('hidden');
            resultadosContainer.classList.add('hidden');
            quizHeaderButtons.classList.add('hidden');
            temaSelectionContainer.classList.add('hidden');
            
            materiaSelectionContainer.classList.remove('hidden');

            appTitle.textContent = "Selección de Materia";
            materiaButtons.innerHTML = ''; 

            Object.keys(MATERIAS).forEach(materiaId => {
                const config = MATERIAS[materiaId];
                const button = document.createElement('button');
                button.textContent = config.name;
                button.classList.add(
                    'w-full', 'py-4', 'px-6', 'text-white', 'font-bold', 'rounded-lg', 'shadow-lg',
                    config.color, config.hover, 'transition', 'duration-150', 'ease-in-out'
                );
                button.addEventListener('click', () => selectMateria(materiaId));
                materiaButtons.appendChild(button);
            });
        }

        function selectMateria(materiaId) {
            currentMateria = materiaId;
            const materiaConfig = MATERIAS[materiaId];
            
            temaSelectionContainer.classList.remove('hidden');
            materiaSelectionContainer.classList.add('hidden');
            
            appTitle.textContent = `Selección de Tema: ${materiaConfig.name}`;
            editorMateriaNombre.textContent = materiaConfig.name;
            currentMateriaName.textContent = materiaConfig.name;

            temaButtons.innerHTML = '<div class="text-center p-4 bg-gray-50 rounded-lg text-gray-700 font-medium flex items-center justify-center"><div class="spinner border-t-2 border-gray-600 w-5 h-5 mr-3"></div> Cargando temas guardados...</div>';
            noTemasMessage.classList.add('hidden');

            loadFullQuestionsList(); 
        }

        function showTemaSelection() {
            quizContainer.classList.add('hidden');
            editorContainer.classList.add('hidden');
            resultadosContainer.classList.add('hidden');
            quizHeaderButtons.classList.add('hidden');
            
            temaSelectionContainer.classList.remove('hidden');
            temaButtons.innerHTML = '';
            
            const temasUnicos = getUniqueThemes();
            const materiaConfig = MATERIAS[currentMateria];

            if (temasUnicos.length > 0) {
                noTemasMessage.classList.add('hidden');
                temasUnicos.forEach(tema => {
                    const count = preguntasMateriaCompleta.filter(p => p.tema === tema).length;
                    const button = document.createElement('button');
                    button.innerHTML = `${tema} <span class="text-sm font-normal">(${count} preguntas)</span>`;
                    button.classList.add(
                        'w-full', 'py-4', 'px-6', 'text-white', 'font-bold', 'rounded-lg', 'shadow-lg',
                        materiaConfig.color, materiaConfig.hover, 'transition', 'duration-150', 'ease-in-out', 'text-left', 'flex', 'justify-between', 'items-center'
                    );
                    button.addEventListener('click', () => selectTema(tema));
                    temaButtons.appendChild(button);
                });
            } else {
                noTemasMessage.classList.add('hidden');
            }
            
            const btnGoToEditor = document.createElement('button');
            btnGoToEditor.textContent = 'Ir al Editor para Agregar Preguntas';
            btnGoToEditor.classList.add(
                'mt-8', 'py-3', 'px-6', 'bg-gray-700', 'text-white', 'font-bold', 'rounded-lg', 'shadow-md', 'hover:bg-gray-800', 'transition', 'duration-150', 'ease-in-out', 'w-full'
            );
            btnGoToEditor.addEventListener('click', () => {
                temaSelectionContainer.classList.add('hidden');
                quizHeaderButtons.classList.remove('hidden');
                alternarVista();
            });
            temaButtons.appendChild(btnGoToEditor);
        }
        
        function selectTema(tema) {
            currentTema = tema;
            currentTemaName.textContent = tema;
            temaSelectionContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            quizHeaderButtons.classList.remove('hidden');
            
            preguntas = preguntasMateriaCompleta
                .map((p, index) => ({ ...p, originalIndex: index }))
                .filter(p => p.tema === tema);
            reiniciarCuestionario();
        }

        function alternarVista() {
            if (vistaActual === 'quiz') {
                vistaActual = 'editor';
                quizContainer.classList.add('hidden');
                resultadosContainer.classList.add('hidden');
                editorContainer.classList.remove('hidden');
                btnAlternarVista.textContent = 'Mostrar Cuestionario';
                editorFeedback.classList.add('hidden'); 
            } else {
                vistaActual = 'quiz';
                editorContainer.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                btnAlternarVista.textContent = 'Mostrar Editor';
                if (indicePreguntaActual < preguntas.length) {
                    cargarPregunta();
                } else {
                    mostrarResultados();
                }
            }
        }

        function setFeedback(message, isError = false) {
            editorFeedback.textContent = message;
            editorFeedback.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (isError) {
                editorFeedback.classList.add('bg-red-100', 'text-red-700');
            } else {
                editorFeedback.classList.add('bg-green-100', 'text-green-700');
            }
        }
        
        function getUniqueThemes() {
            return [...new Set(preguntasMateriaCompleta.map(p => p.tema).filter(t => t && t.trim() !== ''))].sort();
        }
        
        // --- FUNCIONES DE ROBUSTEZ Y API ---

        function cleanJsonString(jsonString) {
            if (!jsonString) return '';
            let cleaned = jsonString.trim();
            if (cleaned.startsWith('```')) {
                const firstNewline = cleaned.indexOf('\n');
                const lastFence = cleaned.lastIndexOf('```');
                if (firstNewline !== -1 && lastFence !== -1 && lastFence > firstNewline) {
                    cleaned = cleaned.substring(firstNewline + 1, lastFence).trim();
                } else {
                    cleaned = cleaned.replace(/^```(json)?\s*/i, '').replace(/\s*```$/, '').trim();
                }
            }
            return cleaned;
        }

        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP Error ${response.status}: ${errorText.substring(0, 100)}...`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    console.error(`Intento ${i + 1} fallido, reintentando en ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Fallo en la comunicación de la API después de múltiples reintentos.");
        }
        
        // --- ✨ NUEVAS FUNCIONES DE IA (GEMINI API) ✨ ---
        
        async function getHint() {
            const pregunta = preguntas[indicePreguntaActual];
            if (!pregunta) return;

            btnPista.disabled = true;
            pistaContainer.textContent = 'Buscando una pista...';
            pistaContainer.classList.remove('hidden');

            const systemPrompt = "Eres un tutor servicial. Para la siguiente pregunta de opción múltiple, proporciona una pista corta y sutil de una sola oración que guíe al usuario hacia la respuesta correcta sin revelarla directamente. Responde en español.";
            const userQuery = `Pregunta: "${pregunta.pregunta}" Opciones: ${pregunta.opciones.join(', ')}`;
            
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            const apiKey = "AIzaSyCX5CYX8TnmpxMMgBoD0zb_mYL0hJLrcP4";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const hint = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (hint) {
                    pistaContainer.textContent = `Pista: ${hint}`;
                } else {
                    throw new Error("La IA no proporcionó una pista.");
                }
            } catch (error) {
                console.error("Error al obtener pista:", error);
                pistaContainer.textContent = 'No se pudo obtener una pista en este momento.';
            }
        }
        
        async function getELI5Explanation() {
            const pregunta = preguntas[indicePreguntaActual];
            if (!pregunta || !pregunta.justificacion) return;

            btnEli5.disabled = true;
            eli5Container.innerHTML = '<div class="spinner border-t-2 border-teal-600 w-5 h-5"></div>';
            eli5Container.classList.remove('hidden');

            const systemPrompt = "Explica el siguiente concepto médico o científico como si el lector tuviera 5 años (ELI5). Usa una analogía simple y un lenguaje muy claro. Responde en español.";
            const userQuery = `Concepto: "${pregunta.justificacion}"`;

            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            const apiKey = "AIzaSyCX5CYX8TnmpxMMgBoD0zb_mYL0hJLrcP4";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const explanation = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (explanation) {
                    eli5Container.innerHTML = `<p><span class="font-bold">En simple:</span> ${explanation}</p>`;
                } else {
                    throw new Error("La IA no proporcionó una explicación.");
                }
            } catch (error) {
                console.error("Error al obtener explicación ELI5:", error);
                eli5Container.textContent = 'No se pudo generar la explicación simplificada.';
            } finally {
                btnEli5.disabled = false;
            }
        }
        
        async function generateReviewQuestions() {
            const topic = iaGenerateTopicInput.value.trim();
            if (topic.length < 3) {
                setFeedback("Por favor, introduce un tema válido para generar preguntas.", true);
                return;
            }
            
            btnIaGenerate.disabled = true;
            iaGenerateSpinner.classList.remove('hidden');
            iaGenerateText.textContent = 'Generando';

            const materiaName = MATERIAS[currentMateria].name;
            const systemPrompt = `Eres un experto en ${materiaName}. Tu tarea es generar 3 preguntas de opción múltiple sobre un tema específico. Cada pregunta debe tener una pregunta, una lista de 4 opciones, el índice de la respuesta correcta (0-3), y una justificación clara. El campo 'tema' debe ser el tema proporcionado por el usuario. Devuelve estrictamente una matriz JSON con el esquema especificado, sin texto adicional.`;
            const userQuery = `Genera 3 preguntas sobre el tema: "${topic}"`;

            const payload = {
                 contents: [{ parts: [{ text: userQuery }] }],
                 systemInstruction: { parts: [{ text: systemPrompt }] },
                 generationConfig: {
                     responseMimeType: "application/json",
                     responseSchema: {
                         type: "ARRAY",
                         items: {
                             type: "OBJECT",
                             properties: {
                                 pregunta: { type: "STRING" },
                                 opciones: { type: "ARRAY", items: { type: "STRING" } },
                                 correctaIndex: { type: "INTEGER" },
                                 justificacion: { type: "STRING" },
                                 tema: { type: "STRING" }
                             },
                             required: ["pregunta", "opciones", "correctaIndex", "justificacion", "tema"]
                         }
                     }
                 }
            };
            const apiKey = "AIzaSyCX5CYX8TnmpxMMgBoD0zb_mYL0hJLrcP4";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("La IA no devolvió preguntas válidas.");
                }
                const jsonString = cleanJsonString(jsonString);
                const newQuestions = JSON.parse(jsonString);

                if (Array.isArray(newQuestions) && newQuestions.length > 0) {
                    const allQuestions = [...preguntasMateriaCompleta, ...newQuestions];
                    const success = await saveAllQuestionsToFirestore(allQuestions);
                    if (success) {
                        setFeedback(`¡Éxito! Se generaron y guardaron ${newQuestions.length} nuevas preguntas para el tema "${topic}".`, false);
                        iaGenerateTopicInput.value = '';
                    }
                } else {
                    throw new Error("La IA devolvió un formato de pregunta inesperado.");
                }

            } catch(error) {
                 console.error("Error al generar preguntas con IA:", error);
                 let errorMessage = error.message;
                 if (errorMessage.includes("HTTP Error 401")) {
                     errorMessage = "Error de Autenticación (401). No se pudo acceder a la IA. Inserta tu clave API.";
                 }
                 setFeedback(`Error al generar preguntas: ${errorMessage}`, true);
            } finally {
                btnIaGenerate.disabled = false;
                iaGenerateSpinner.classList.add('hidden');
                iaGenerateText.textContent = 'Generar';
            }
        }
            

        // --- FUNCIONES DE VALIDACIÓN Y CARGA MASIVA ---
        
        async function verifySingleQuestion() {
            const index = parseInt(editQuestionIndex.value);
            const question = { ...preguntasMateriaCompleta[index] };
            if (!question) return;

            btnVerifyIa.disabled = true;
            btnVerifyIa.textContent = "Verificando...";
            setEditFeedback("Verificando la pregunta y buscando justificación con IA...", false);
            
            try {
                const validatedQuestions = await validateAndRefineQuestions([question]);
                if (validatedQuestions && validatedQuestions.length > 0) {
                    const validatedQ = validatedQuestions[0];
                    // Solo actualizamos los campos que la IA debe cambiar
                    editCorrectaIndex.value = validatedQ.correctaIndex;
                    editJustificacion.value = validatedQ.justificacion;
                    
                    if (validatedQ.correctaIndex !== question.correctaIndex) {
                        setEditFeedback("¡La IA corrigió la respuesta marcada! Revisa los cambios y haz clic en Guardar.", true);
                    } else {
                        setEditFeedback("Verificación exitosa. Justificación mejorada. Haz clic en Guardar.", false);
                    }
                } else {
                    throw new Error("La IA no devolvió una pregunta validada.");
                }
            } catch (error) {
                console.error("Error en la verificación individual:", error);
                let errorMessage = error.message;
                if (errorMessage.includes("HTTP Error 401")) {
                     errorMessage = "Error de Autenticación (401). No se pudo acceder a la IA. Inserta tu clave API.";
                } else if (errorMessage.includes("Timeout")) {
                     errorMessage = "Tiempo de espera agotado. Intenta de nuevo.";
                }
                setEditFeedback(`Fallo en Fact-Check: ${errorMessage}`, true);
            } finally {
                btnVerifyIa.disabled = false;
                btnVerifyIa.textContent = "✨ Verificar con IA";
            }
        }
        
        async function validateAndRefineQuestions(questions) {
             const materiaName = MATERIAS[currentMateria].name;
             const questionsJsonString = JSON.stringify(questions);
             const systemPrompt = `Eres un experto revisor y validador de exámenes médicos. Tu tarea es: 1. Revisar la pregunta y las opciones proporcionadas. NO LAS MODIFIQUES. Deben permanecer idénticas. 2. Verifica la precisión de la 'correctaIndex' usando tu conocimiento. Si es incorrecta, corrígela al índice correcto. 3. Mejora o completa el campo 'justificacion' para que sea claro y educativo. 4. Devuelve estrictamente SÓLO la matriz JSON. Los campos 'pregunta' y 'opciones' deben ser textualmente idénticos a los que recibiste. Mantén el 'tema' idéntico.`;
             const userQuery = `Revisa y refina el siguiente conjunto de preguntas sobre ${materiaName}: ${questionsJsonString}`;
             const payload = {
                 contents: [{ parts: [{ text: userQuery }] }],
                 systemInstruction: { parts: [{ text: systemPrompt }] },
                 generationConfig: {
                     responseMimeType: "application/json",
                     responseSchema: {
                         type: "ARRAY",
                         items: {
                             type: "OBJECT",
                             properties: {
                                 pregunta: { type: "STRING" },
                                 opciones: { type: "ARRAY", items: { type: "STRING" } },
                                 correctaIndex: { type: "INTEGER" },
                                 justificacion: { type: "STRING" },
                                 tema: { type: "STRING" }
                             },
                             required: ["pregunta", "opciones", "correctaIndex", "justificacion", "tema"]
                         }
                     }
                 }
             };
             const apiKey = "AIzaSyCX5CYX8TnmpxMMgBoD0zb_mYL0hJLrcP4"; 
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
             const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
             const result = await response.json();
             const candidate = result.candidates?.[0];
             if (candidate && candidate.content?.parts?.[0]?.text) {
                 const jsonString = candidate.content.parts[0].text;
                 const cleanedJson = cleanJsonString(jsonString);
                 if (cleanedJson.length === 0) throw new Error("La IA de validación devolvió una respuesta vacía.");
                 const parsed = JSON.parse(cleanedJson);
                 // Forzamos que la pregunta y opciones originales se mantengan
                 return parsed.map((item, index) => ({
                    ...item,
                    pregunta: questions[index].pregunta,
                    opciones: questions[index].opciones
                 }));
             } else {
                 throw new Error("Respuesta de validación incompleta o fallida.");
             }
        }

        async function structurePastedText(rawText, tema) {
             const materiaName = MATERIAS[currentMateria].name;
             const systemPrompt = `Eres un asistente de entrada de datos experto en ${materiaName}. Tu única tarea es convertir el siguiente texto, que contiene múltiples preguntas de opción múltiple, en una matriz JSON. Cada objeto en la matriz debe tener las siguientes claves: "pregunta" (string), "opciones" (array de 4 strings), "correctaIndex" (integer 0-3), y "justificacion" (string). Si no encuentras una justificación, déjala como un string vacío. El campo "tema" para TODAS las preguntas debe ser exactamente "${tema}". Responde estrictamente SÓLO con la matriz JSON, sin ningún texto adicional o explicaciones.`;
             const userQuery = `Aquí está el texto para procesar:\n\n${rawText}`;

             const payload = {
                 contents: [{ parts: [{ text: userQuery }] }],
                 systemInstruction: { parts: [{ text: systemPrompt }] },
                 generationConfig: {
                     responseMimeType: "application/json",
                     responseSchema: {
                         type: "ARRAY",
                         items: {
                             type: "OBJECT",
                             properties: {
                                 pregunta: { type: "STRING" },
                                 opciones: { type: "ARRAY", items: { type: "STRING" } },
                                 correctaIndex: { type: "INTEGER" },
                                 justificacion: { type: "STRING" },
                                 tema: { type: "STRING" }
                             },
                             required: ["pregunta", "opciones", "correctaIndex", "justificacion", "tema"]
                         }
                     }
                 }
             };
             const apiKey = "AIzaSyCX5CYX8TnmpxMMgBoD0zb_mYL0hJLrcP4"; 
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
             
             const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
             const result = await response.json();
             const candidate = result.candidates?.[0];

             if (candidate && candidate.content?.parts?.[0]?.text) {
                 const jsonString = candidate.content.parts[0].text;
                 const cleanedJson = cleanJsonString(jsonString);
                 if (cleanedJson.length === 0) throw new Error("La IA de estructuración devolvió una respuesta vacía.");
                 return JSON.parse(cleanedJson);
             } else {
                 throw new Error("La respuesta de la IA para estructurar el texto fue incompleta o falló.");
             }
        }

        async function analyzePastedText() {
            const rawText = textoPdf.value.trim();
            const tema = temaInput.value.trim();
            if (!tema) {
                setFeedback("¡El campo 'Tema a Asignar' es obligatorio para la carga masiva!", true);
                return;
            }
            if (rawText.length < 20) {
                setFeedback("Pega un texto más largo que contenga al menos una pregunta completa.", true);
                return;
            }

            btnAnalizar.disabled = true;
            analizarSpinner.classList.remove('hidden');
            analizarText.textContent = 'Analizando...';
            setFeedback('Estructurando el texto con la IA...', false);
            
            try {
                // Llama a la nueva función simple
                const newQuestions = await structurePastedText(rawText, tema);
                
                if (!Array.isArray(newQuestions) || newQuestions.length === 0) {
                    throw new Error("La IA no pudo estructurar el texto. Revisa el formato del texto pegado.");
                }

                const allQuestions = [...preguntasMateriaCompleta, ...newQuestions];
                const success = await saveAllQuestionsToFirestore(allQuestions);

                if (success) {
                    setFeedback(`¡Éxito! Se cargaron y guardaron ${newQuestions.length} nuevas preguntas para el tema "${tema}".`, false);
                    textoPdf.value = '';
                    temaInput.value = '';
                }

            } catch (error) {
                console.error("Error en la carga masiva:", error);
                let errorMessage = error.message;
                if (errorMessage.includes("401")) {
                    errorMessage = "Error de Autenticación (401). No se pudo conectar con la IA. Inserta tu clave API.";
                }
                setFeedback(`Error: ${errorMessage}`, true);
            } finally {
                btnAnalizar.disabled = false;
                analizarSpinner.classList.add('hidden');
                analizarText.textContent = 'Analizar y Cargar Preguntas';
            }
        }


        // --- FUNCIONES PRINCIPALES DEL CUESTIONARIO ---

        function cargarPregunta() {
            seleccionActual = null;
            respuestaComprobada = false;
            feedbackContainer.classList.add('hidden-transition', 'hidden');
            justificacionBox.classList.add('hidden');
            pistaContainer.classList.add('hidden');
            eli5Container.classList.add('hidden');
            btnPista.disabled = false;
            btnEli5.disabled = false;
            btnVerifyQuiz.style.display = 'none';
            verifyQuizFeedback.textContent = '';


            btnSiguiente.disabled = true;
            btnSiguiente.textContent = "Siguiente Pregunta";
            btnSiguiente.classList.replace('bg-indigo-600', 'bg-gray-300');
            btnSiguiente.classList.replace('text-white', 'text-gray-700');

            if (preguntas.length === 0) {
                 preguntaTexto.textContent = `No hay preguntas cargadas para el tema "${currentTema}". Ve al Editor para añadir preguntas.`;
                 contadorPregunta.textContent = "0 preguntas";
                 totalPreguntasSpan.textContent = "0";
                 opcionesContainer.innerHTML = '';
                 btnAlternarVista.textContent = 'Mostrar Editor'; 
                 return;
            }

            if (indicePreguntaActual >= preguntas.length) {
                mostrarResultados();
                return;
            }

            const pregunta = preguntas[indicePreguntaActual];
            preguntaTexto.textContent = pregunta.pregunta;
            contadorPregunta.textContent = `Pregunta ${indicePreguntaActual + 1} de ${preguntas.length}`;
            totalPreguntasSpan.textContent = preguntas.length;
            puntajeSpan.textContent = puntaje; 

            opcionesContainer.innerHTML = '';
            pregunta.opciones.forEach((opcion, index) => {
                const btn = document.createElement('button');
                btn.textContent = opcion;
                btn.classList.add('opcion-btn', 'w-full', 'py-3', 'px-4', 'text-left', 'bg-gray-50', 'text-gray-800', 'border-2', 'border-gray-200', 'rounded-lg', 'font-medium', 'focus:outline-none');
                btn.dataset.index = index;
                btn.addEventListener('click', seleccionarOpcion);
                opcionesContainer.appendChild(btn);
            });
        }

        function seleccionarOpcion(event) {
            if (respuestaComprobada) return; 

            respuestaComprobada = true; 
            btnPista.disabled = true;
            const pregunta = preguntas[indicePreguntaActual];
            const opcionesBotones = document.querySelectorAll('.opcion-btn');
            const botonSeleccionado = event.target;
            seleccionActual = parseInt(botonSeleccionado.dataset.index);
            const esCorrecta = seleccionActual === pregunta.correctaIndex;

            opcionesBotones.forEach((btn, index) => {
                btn.disabled = true;
                // Siempre marca la respuesta correcta en verde para que el usuario aprenda.
                if (index === pregunta.correctaIndex) {
                    btn.classList.add('correcta');
                } 
                // Si la opción seleccionada NO es la correcta, márcala en rojo.
                else if (index === seleccionActual) {
                    btn.classList.add('incorrecto');
                }
            });

            if (esCorrecta) {
                puntaje++;
                puntajeSpan.textContent = puntaje;
                feedbackTexto.textContent = "✅ ¡Respuesta Correcta!";
                feedbackTexto.className = 'p-3 rounded-lg text-center font-bold bg-green-100 text-green-700';
            } else {
                feedbackTexto.textContent = "❌ Respuesta Incorrecta. La opción correcta está marcada en verde.";
                feedbackTexto.className = 'p-3 rounded-lg text-center font-bold bg-red-100 text-red-700';
            }
            feedbackContainer.classList.remove('hidden-transition', 'hidden');
            feedbackContainer.classList.add('visible-transition');

            if (pregunta.justificacion && pregunta.justificacion.trim() !== "") {
                 justificacionTexto.textContent = pregunta.justificacion.trim();
                 justificacionBox.classList.remove('hidden');
                 btnVerifyQuiz.style.display = 'block';
            } else {
                 justificacionBox.classList.add('hidden');
            }

            btnSiguiente.disabled = false;
            btnSiguiente.classList.replace('bg-gray-300', 'bg-indigo-600');
            btnSiguiente.classList.replace('text-gray-700', 'text-white');

            if (indicePreguntaActual === preguntas.length - 1) {
                 btnSiguiente.textContent = "Ver Resultados";
                 btnSiguiente.classList.replace('bg-indigo-600', 'bg-emerald-600');
            }
        }
        
        async function verifyCurrentQuestionInQuiz() {
            const preguntaActual = preguntas[indicePreguntaActual];
            if (!preguntaActual) return;

            btnVerifyQuiz.disabled = true;
            verifyQuizFeedback.textContent = 'Verificando...';
            verifyQuizFeedback.className = 'mt-2 text-xs text-center text-blue-600';

            try {
                const { originalIndex, ...questionToVerify } = preguntaActual;
                
                const validatedQuestions = await validateAndRefineQuestions([questionToVerify]);

                if (!validatedQuestions || validatedQuestions.length === 0) {
                    throw new Error("La IA no devolvió una pregunta validada.");
                }

                const validatedQ = validatedQuestions[0];
                
                // --- Actualización de lista completa para guardado ---
                const updatedList = [...preguntasMateriaCompleta];
                updatedList[originalIndex] = validatedQ;

                const success = await saveAllQuestionsToFirestore(updatedList);

                if (success) {
                    // Actualizamos la pregunta en la lista actual de la sesión
                    preguntas[indicePreguntaActual] = { ...validatedQ, originalIndex: originalIndex };
                    justificacionTexto.textContent = validatedQ.justificacion;
                    
                    // Repintamos el estado de las opciones basándonos en la nueva respuesta correcta
                    const opcionesBotones = document.querySelectorAll('.opcion-btn');
                    opcionesBotones.forEach((btn, index) => {
                        btn.classList.remove('correcto', 'incorrecto');
                        if (index === validatedQ.correctaIndex) {
                            btn.classList.add('correcto');
                        } else if (index === seleccionActual) {
                            btn.classList.add('incorrecto');
                        }
                    });

                    if (preguntaActual.correctaIndex !== validatedQ.correctaIndex) {
                         verifyQuizFeedback.textContent = '¡La IA ha corregido la respuesta! La vista ha sido actualizada.';
                         verifyQuizFeedback.className = 'mt-2 text-xs text-center text-red-600 font-bold';
                    } else {
                         verifyQuizFeedback.textContent = 'Verificación completa. La justificación ha sido actualizada.';
                         verifyQuizFeedback.className = 'mt-2 text-xs text-center text-green-600';
                    }
                } else {
                    // El guardado en la nube falló, pero el local fue exitoso.
                    verifyQuizFeedback.textContent = 'Verificación exitosa. La justificación fue actualizada localmente.';
                    verifyQuizFeedback.className = 'mt-2 text-xs text-center text-yellow-700';
                }

            } catch(error) {
                console.error("Error al verificar la pregunta en el quiz:", error);
                let errorMessage = error.message;
                if (errorMessage.includes("401") || errorMessage.includes("403")) {
                     errorMessage = "Error de Autenticación (401/403). Debes insertar tu clave API de Gemini.";
                }
                verifyQuizFeedback.textContent = `Error: ${errorMessage}`;
                verifyQuizFeedback.className = 'mt-2 text-xs text-center text-red-600';
            } finally {
                btnVerifyQuiz.disabled = false;
            }
        }


        function siguientePregunta() {
            if (!respuestaComprobada) return;
            indicePreguntaActual++;
            cargarPregunta();
        }

        function mostrarResultados() {
            quizContainer.classList.add('hidden');
            quizHeaderButtons.classList.add('hidden');
            resultadosContainer.classList.remove('hidden');
            resultadoFinal.textContent = `${puntaje} / ${preguntas.length}`;
            const porcentaje = preguntas.length > 0 ? (puntaje / preguntas.length) * 100 : 0;
            resultadoFinal.className = 'text-6xl font-extrabold mb-8';
            if (porcentaje >= 80) resultadoFinal.classList.add('text-green-600');
            else if (porcentaje >= 50) resultadoFinal.classList.add('text-yellow-600');
            else resultadoFinal.classList.add('text-red-600');
        }

        function reiniciarCuestionario() {
            indicePreguntaActual = 0;
            puntaje = 0;
            puntajeSpan.textContent = 0;
            resultadosContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            quizHeaderButtons.classList.remove('hidden');
            if (preguntas.length > 0) shuffleArray(preguntas);
            cargarPregunta();
        }

        // --- MANEJO DE VISTAS DEL EDITOR ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[i], array[j]];
            }
        }

        function toggleCargaMasiva() {
            cargaMasivaContainer.classList.toggle('hidden');
            const isHidden = cargaMasivaContainer.classList.contains('hidden');
            btnToggleCargaMasiva.textContent = isHidden ? 'Mostrar Carga Masiva de Texto' : 'Ocultar Carga Masiva de Texto';
        }

        // --- LISTENERS DE EVENTOS ---
        btnSiguiente.addEventListener('click', siguientePregunta);
        btnReiniciar.addEventListener('click', reiniciarCuestionario);
        btnAlternarVista.addEventListener('click', alternarVista);
        btnCambiarMateria.addEventListener('click', showMateriaSelection);
        btnVolverMateria.addEventListener('click', showMateriaSelection);
        btnCancelEdit.addEventListener('click', () => editModalOverlay.classList.add('hidden'));
        btnSaveEdit.addEventListener('click', saveEditChanges);
        btnVerifyIa.addEventListener('click', verifySingleQuestion);
        // ✨ Listeners para nuevas funciones de IA ✨
        btnPista.addEventListener('click', getHint);
        btnEli5.addEventListener('click', getELI5Explanation);
        btnIaGenerate.addEventListener('click', generateReviewQuestions);
        btnVerifyQuiz.addEventListener('click', verifyCurrentQuestionInQuiz);
        // Listener para Carga Masiva
        btnToggleCargaMasiva.addEventListener('click', toggleCargaMasiva);
        btnAnalizar.addEventListener('click', analyzePastedText);


        // --- INICIO DE LA APLICACIÓN ---
        window.onload = function() {
            initFirebase();
        }
    </script>
</body>
</html>

