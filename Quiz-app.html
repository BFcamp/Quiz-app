<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz ¬∑ Editor ¬∑ Config (SPA)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-active{border-color:#6366f1;color:#4338ca;background:#eef2ff}
    .opcion-btn{transition:all .2s}
    .opcion-btn:not(.correcta):not(.incorrecta):hover{transform:translateY(-2px);box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1)}
    .correcta{background-color:#10b981!important;color:#fff!important;border-color:#059669!important}
    .incorrecta{background-color:#ef4444!important;color:#fff!important;border-color:#dc2626!important}
    .hidden-transition{opacity:0;max-height:0;overflow:hidden;transition:opacity .3s ease-out,max-height .3s ease-out}
    .visible-transition{opacity:1;max-height:500px}
    .spinner{border:4px solid rgba(0,0,0,.2);border-top:4px solid #4f46e5;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
    <header class="px-6 py-5 border-b flex items-center gap-3">
      <div class="w-8 h-8 grid place-content-center rounded-lg bg-indigo-600 text-white font-black">Q</div>
      <div>
        <h1 class="text-xl font-extrabold text-gray-900">Quiz Manager</h1>
        <p id="conn" class="text-xs font-semibold text-gray-500">offline</p>
      </div>
      <div class="ml-auto flex gap-2">
        <button id="tab-quiz" class="px-3 py-1.5 rounded-lg border text-sm">Quiz</button>
        <button id="tab-editor" class="px-3 py-1.5 rounded-lg border text-sm">Editor</button>
        <button id="tab-config" class="px-3 py-1.5 rounded-lg border text-sm">Config</button>
      </div>
    </header>

    <!-- QUIZ PANEL -->
    <section id="panel-quiz" class="p-6">
      <div class="flex flex-col md:flex-row md:items-end gap-3 mb-5">
        <div class="flex-1">
          <label class="text-xs text-gray-500">Materia</label>
          <select id="sel-materia" class="w-full border rounded-lg p-2.5"></select>
        </div>
        <div class="flex-1">
          <label class="text-xs text-gray-500">Tema</label>
          <select id="sel-tema" class="w-full border rounded-lg p-2.5"></select>
        </div>
        <div class="flex items-end gap-2">
          <button id="btn-refresh" class="px-4 py-2 rounded-lg border bg-indigo-600 text-white">üîÑ Refrescar</button>
          <button id="btn-start" class="px-4 py-2 rounded-lg border">‚ñ∂Ô∏è Empezar</button>
        </div>
      </div>

      <div id="quiz-box" class="hidden">
        <div class="flex justify-between items-center mb-3 text-sm text-gray-600">
          <div>Pregunta <span id="q-idx">1</span>/<span id="q-total">0</span></div>
          <div>Puntaje: <span id="score">0</span></div>
        </div>
        <div class="bg-indigo-50 border border-indigo-100 p-5 rounded-xl mb-4">
          <h2 id="q-text" class="text-lg font-bold text-gray-900">‚Äî</h2>
        </div>
        <div id="q-opts" class="space-y-2"></div>
        <div id="q-feedback" class="mt-4 hidden-transition"><p id="q-feedback-text" class="p-3 rounded-lg text-center font-bold"></p>
          <div id="q-just-box" class="mt-3 p-3 bg-gray-50 border rounded-lg hidden">
            <div class="text-xs font-bold text-indigo-600 mb-1">Justificaci√≥n</div>
            <div id="q-just" class="text-sm text-gray-700"></div>
          </div>
        </div>
        <div class="mt-5">
          <button id="btn-next" disabled class="w-full px-4 py-3 rounded-lg bg-gray-200">Siguiente</button>
        </div>
      </div>

      <div id="quiz-result" class="hidden text-center py-10">
        <h3 class="text-2xl font-extrabold text-indigo-700 mb-2">¬°Listo!</h3>
        <p class="text-gray-600 mb-6">Tu puntaje final es <span id="final-score" class="font-bold">0/0</span>.</p>
        <button id="btn-retry" class="px-5 py-2 rounded-full bg-emerald-600 text-white">Repetir</button>
      </div>
    </section>

    <!-- EDITOR PANEL -->
    <section id="panel-editor" class="p-6 hidden">
      <div class="flex flex-col md:flex-row md:items-end gap-3 mb-6">
        <div class="flex-1">
          <label class="text-xs text-gray-500">Materia</label>
          <input id="e-materia" class="w-full border rounded-lg p-2.5" placeholder="p.ej., Toxicolog√≠a" />
        </div>
        <div class="flex-1">
          <label class="text-xs text-gray-500">Tema</label>
          <input id="e-tema" class="w-full border rounded-lg p-2.5" placeholder="p.ej., Anticoagulantes" />
        </div>
        <div class="flex items-end gap-2">
          <button id="btn-guardar-cloud" class="px-4 py-2 rounded-lg border bg-indigo-600 text-white">üíæ Guardar</button>
          <button id="btn-releer-cloud" class="px-4 py-2 rounded-lg border">üîÑ Releer</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="space-y-3">
          <label class="text-xs text-gray-500">Pregunta</label>
          <textarea id="e-pregunta" rows="3" class="w-full border rounded-lg p-2.5" placeholder="Enunciado"></textarea>
          <label class="text-xs text-gray-500">Opciones (A|B|C|D)</label>
          <input id="e-opciones" class="w-full border rounded-lg p-2.5" placeholder="Opci√≥n A | Opci√≥n B | Opci√≥n C | Opci√≥n D" />
          <label class="text-xs text-gray-500">√çndice correcto (0‚Äì3)</label>
          <input id="e-correcta" type="number" min="0" max="9" value="0" class="w-full border rounded-lg p-2.5" />
          <label class="text-xs text-gray-500">Justificaci√≥n (opcional)</label>
          <textarea id="e-just" rows="2" class="w-full border rounded-lg p-2.5" placeholder="Breve explicaci√≥n"></textarea>
          <div class="flex gap-2">
            <button id="btn-add-local" class="px-4 py-2 rounded-lg border bg-emerald-600 text-white">‚ûï Agregar a la lista</button>
            <button id="btn-clear-form" class="px-4 py-2 rounded-lg border">üßπ Limpiar</button>
          </div>
        </div>
        <div class="space-y-3">
          <label class="text-xs text-gray-500">Carga masiva (pegar bloques)</label>
          <textarea id="e-paste" rows="10" class="w-full border rounded-lg p-2.5 mono" placeholder="Pregunta‚Ä¶
A) ‚Ä¶
B) ‚Ä¶
C) ‚Ä¶
D) ‚Ä¶
Correcta: B
Justificaci√≥n: ‚Ä¶

(Peg√° varios bloques separados por una l√≠nea en blanco)"></textarea>
          <button id="btn-procesar-paste" class="w-full px-4 py-2 rounded-lg border">üì• Procesar pegado</button>
        </div>
      </div>

      <div id="e-feedback" class="mt-4 hidden p-3 rounded-lg text-sm"></div>

      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-bold text-gray-800">Preguntas en edici√≥n (<span id="e-count">0</span>)</h3>
          <div class="flex gap-2">
            <button id="btn-export" class="px-3 py-1.5 rounded-lg border">‚¨áÔ∏è Exportar JSON</button>
            <button id="btn-import" class="px-3 py-1.5 rounded-lg border">‚¨ÜÔ∏è Importar JSON</button>
          </div>
        </div>
        <div id="e-list" class="divide-y border rounded-xl"></div>
      </div>
    </section>

    <!-- CONFIG PANEL -->
    <section id="panel-config" class="p-6 hidden">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Conexi√≥n</h3>
      <label class="text-xs text-gray-500">Google Apps Script Web App URL</label>
      <input id="cfg-url" class="w-full border rounded-lg p-2.5 mb-3" placeholder="https://script.google.com/macros/s/XXXX/exec" />
      <p class="text-sm text-gray-600 mb-4">Peg√° ac√° la URL de tu Web App. La guardamos en <span class="mono">localStorage</span>.</p>
      <div class="flex gap-2">
        <button id="btn-save-cfg" class="px-4 py-2 rounded-lg border bg-indigo-600 text-white">Guardar</button>
        <button id="btn-test-cfg" class="px-4 py-2 rounded-lg border">Probar conexi√≥n</button>
      </div>
      <p id="cfg-feedback" class="mt-3 text-sm"></p>
    </section>
  </div>

  <script>
  // =========================
  // CONFIG
  // =========================
  const STORAGE_KEY = 'quiz-spa-config-v1';
  const DEFAULT_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiqa6L11JeWjMvctdSJLLKLRaSdr8G_CQRkORq6OeP1eBjaxF7CFDk-icTqNDgsp3qaPfZIzuid6wp_qdfqs6h2I-MfGn6djcIcrUWPDmGIi4d0tBQbQdp8bDkTzDuor1TFGkl4D8oRtwafbbPuI3dXiPJ4Yi8nBKotkc-TK3x-0yR569shWzotfy_Lmmgq1iPssOdJ2ex-dmzGDUy0jtIx09Z8VaBnrYhHaJWvigf5e4geMStRqBCN0yzvZ0G4atjYBa1SDel0EJNRfn5jxivk2e1C_5ND-4nIN1qX&lib=M0ouz-MrO7jH1KJF7KFs_uSae7Ado8u_k"; // Tu URL por defecto
  let SCRIPT_URL = DEFAULT_URL;

  // =========================
  // STATE
  // =========================
  let all = [];        // todas desde nube
  let localList = [];  // en edici√≥n
  let quizList = [];   // preguntas del quiz seg√∫n selecci√≥n
  let qIdx = 0; let score = 0;

  // =========================
  // DOM helpers
  // =========================
  const $ = (id)=>document.getElementById(id);
  const panels = { quiz: $('panel-quiz'), editor: $('panel-editor'), config: $('panel-config') };
  const tabs = { quiz: $('tab-quiz'), editor: $('tab-editor'), config: $('tab-config') };
  function setTab(name){
    Object.values(panels).forEach(p=>p.classList.add('hidden'));
    Object.values(tabs).forEach(t=>t.classList.remove('tab-active'));
    panels[name].classList.remove('hidden');
    tabs[name].classList.add('tab-active');
  }

  function setConn(state){
    const el=$('conn');
    if(state==='online'){ el.textContent='online'; el.className='text-xs font-semibold text-green-700'; }
    else if(state==='connecting'){ el.textContent='conectando‚Ä¶'; el.className='text-xs font-semibold text-yellow-700'; }
    else { el.textContent='offline'; el.className='text-xs font-semibold text-red-700'; }
  }

  function feedback(el, msg, good){
    el.textContent = msg;
    el.className = 'mt-4 p-3 rounded-lg text-sm ' + (good? 'bg-green-100 text-green-700':'bg-red-100 text-red-700');
    el.classList.remove('hidden');
  }

  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  function normalize(list){
    const out=[]; (Array.isArray(list)?list:[]).forEach(q=>{
      if(!q) return;
      let opciones = q.opciones;
      if(typeof opciones==='string'){
        try{ opciones = JSON.parse(opciones); }catch{ opciones = String(opciones).split('|').map(s=>s.trim()).filter(Boolean); }
      }
      const ci = Number(q.correctaindex);
      const obj = {
        id:(q.id??'').toString(),
        materia:(q.materia??'').toString().trim(),
        tema:(q.tema??'').toString().trim(),
        pregunta:(q.pregunta??'').toString().trim(),
        opciones:Array.isArray(opciones)?opciones:[],
        correctaindex:Number.isFinite(ci)?ci:-1,
        justificacion:(q.justificacion??'').toString(),
        _updatedAt:q._updatedAt||'',
        _clientId:q._clientId||''
      };
      const ok = obj.id && obj.materia && obj.tema && obj.pregunta && obj.opciones.length>0 && obj.correctaindex>=0 && obj.correctaindex<obj.opciones.length;
      if(ok) out.push(obj);
    });
    return out;
  }

  async function fetchCloud(){
    setConn('connecting');
    try{
      const res = await fetch(SCRIPT_URL+"&t="+Date.now(), {cache:'no-store'});
      const data = await res.json();
      const arr = Array.isArray(data)? data : (Array.isArray(data?.data)? data.data : []);
      all = normalize(arr);
      setConn('online');
      fillSelectors();
      return all;
    }catch(e){ console.error(e); setConn('offline'); return []; }
  }

  async function saveCloud(rows){
    try{
      const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rows }) });
      const data = await res.json().catch(()=>null);
      if(data && (Array.isArray(data) || Array.isArray(data.data))){
        all = normalize(Array.isArray(data)?data:data.data);
        fillSelectors();
        return true;
      }
      return false;
    }catch(e){ return false; }
  }

  function fillSelectors(){
    const sm=$('sel-materia'), st=$('sel-tema');
    const materias = [...new Set(all.map(q=>q.materia).filter(Boolean))].sort();
    sm.innerHTML = '<option value="">‚Äî elegir ‚Äî</option>' + materias.map(m=>`<option>${escapeHtml(m)}</option>`).join('');
    st.innerHTML = '<option value="">‚Äî elegir ‚Äî</option>';
  }

  function fillTemas(){
    const m=$('sel-materia').value; const st=$('sel-tema');
    const temas = [...new Set(all.filter(q=>q.materia===m).map(q=>q.tema).filter(Boolean))].sort();
    st.innerHTML = '<option value="">‚Äî elegir ‚Äî</option>' + temas.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
  }

  function loadQuestion(){
    if(!quizList.length){ $('q-text').textContent='No hay preguntas'; return; }
    if(qIdx>=quizList.length){ showResults(); return; }
    const q = quizList[qIdx];
    $('q-idx').textContent = String(qIdx+1); $('q-total').textContent = String(quizList.length);
    $('q-text').textContent = q.pregunta;
    const box=$('q-opts'); box.innerHTML='';
    q.opciones.forEach((op,i)=>{
      const b=document.createElement('button');
      b.className='opcion-btn w-full py-3 px-4 text-left bg-gray-50 text-gray-800 border-2 border-gray-200 rounded-lg';
      b.textContent=op; b.onclick=()=>selectOption(i);
      box.appendChild(b);
    });
    $('q-feedback').classList.add('hidden','hidden-transition');
    const btn=$('btn-next'); btn.disabled=true; btn.className='w-full px-4 py-3 rounded-lg bg-gray-200'; btn.textContent='Siguiente';
    $('q-just-box').classList.add('hidden');
  }

  function selectOption(i){
    const q = quizList[qIdx];
    document.querySelectorAll('#q-opts button').forEach((b,j)=>{ b.disabled=true; if(j===q.correctaindex) b.classList.add('correcta'); else if(j===i) b.classList.add('incorrecta'); });
    if(i===q.correctaindex){ score++; $('score').textContent=String(score); $('q-feedback-text').textContent='‚úÖ ¬°Correcto!'; $('q-feedback-text').className='p-3 rounded-lg text-center font-bold bg-green-100 text-green-700'; }
    else { $('q-feedback-text').textContent='‚ùå Incorrecto. La opci√≥n correcta est√° en verde.'; $('q-feedback-text').className='p-3 rounded-lg text-center font-bold bg-red-100 text-red-700'; }
    $('q-feedback').classList.remove('hidden','hidden-transition'); $('q-feedback').classList.add('visible-transition');
    if(q.justificacion){ $('q-just').textContent=q.justificacion; $('q-just-box').classList.remove('hidden'); }
    const last = (qIdx===quizList.length-1); const btn=$('btn-next'); btn.disabled=false; btn.textContent= last? 'Ver resultados' : 'Siguiente'; btn.className='w-full px-4 py-3 rounded-lg bg-indigo-600 text-white';
  }

  function nextQuestion(){ qIdx++; loadQuestion(); }
  function showResults(){ $('quiz-box').classList.add('hidden'); $('quiz-result').classList.remove('hidden'); $('final-score').textContent = `${score}/${quizList.length}`; }
  function retry(){ $('quiz-result').classList.add('hidden'); startQuiz(); }

  function startQuiz(){ qIdx=0; score=0; $('score').textContent='0'; $('quiz-box').classList.remove('hidden'); $('quiz-result').classList.add('hidden'); loadQuestion(); }

  // ======= Editor helpers =======
  function updateEditorList(){
    $('e-count').textContent = String(localList.length);
    const box=$('e-list'); box.innerHTML='';
    localList.forEach(q=>{
      const row=document.createElement('div'); row.className='p-3 flex gap-3 items-start';
      row.innerHTML = `<div class='flex-1'>
        <div class='text-sm font-bold text-indigo-700 mb-1'>${escapeHtml(q.pregunta)}</div>
        <div class='text-xs text-gray-500'>${escapeHtml(q.materia)} ‚Ä¢ ${escapeHtml(q.tema)} ‚Ä¢ correcta: ${q.correctaindex}</div>
        <div class='text-xs text-gray-500 mono break-all'>${q.opciones.map(escapeHtml).join(' | ')}</div>
      </div>
      <div class='flex gap-2'>
        <button data-id='${q.id}' class='px-3 py-1.5 rounded-lg border text-xs btn-edit'>Editar</button>
        <button data-id='${q.id}' class='px-3 py-1.5 rounded-lg border text-xs text-white bg-red-600 btn-del'>Eliminar</button>
      </div>`;
      box.appendChild(row);
    });
    box.querySelectorAll('.btn-del').forEach(b=> b.onclick=(e)=>{ const id=e.currentTarget.getAttribute('data-id'); localList = localList.filter(x=>x.id!==id); updateEditorList(); });
    box.querySelectorAll('.btn-edit').forEach(b=> b.onclick=(e)=>{
      const id=e.currentTarget.getAttribute('data-id'); const q=localList.find(x=>x.id===id); if(!q) return;
      $('e-materia').value=q.materia; $('e-tema').value=q.tema; $('e-pregunta').value=q.pregunta; $('e-opciones').value=q.opciones.join(' | '); $('e-correcta').value=String(q.correctaindex); $('e-just').value=q.justificacion||'';
      localList = localList.filter(x=>x.id!==id); updateEditorList();
    });
  }

  function addLocal(){
    const materia=$('e-materia').value.trim(); const tema=$('e-tema').value.trim(); const pregunta=$('e-pregunta').value.trim();
    const opciones=$('e-opciones').value.split('|').map(s=>s.trim()).filter(Boolean); const correcta=Number($('e-correcta').value); const jus=$('e-just').value.trim();
    if(!materia||!tema||!pregunta||!opciones.length||!Number.isInteger(correcta)||correcta<0||correcta>=opciones.length){ feedback($('e-feedback'),'Completa todos los campos v√°lidos.',false); return; }
    const row={ id: Date.now()+"-"+Math.random().toString(36).slice(2,8), materia, tema, pregunta, opciones, correctaindex: correcta, justificacion: jus, _updatedAt: new Date().toISOString() };
    localList.push(row); updateEditorList();
    feedback($('e-feedback'),'Agregada a la lista local. Presion√° ‚ÄúGuardar‚Äù para subir a la nube.',true);
    $('e-pregunta').value=''; $('e-opciones').value=''; $('e-correcta').value='0'; $('e-just').value='';
  }

  function processPaste(){
    const materia=$('e-materia').value.trim(); const tema=$('e-tema').value.trim(); const txt=$('e-paste').value.trim();
    if(!materia||!tema){ feedback($('e-feedback'),'Indic√° Materia y Tema antes de pegar.',false); return; }
    if(txt.length<10){ feedback($('e-feedback'),'Pega contenido suficiente.',false); return; }
    const bloques = txt.split(/\n\s*\n+/);
    let added=0;
    bloques.forEach(b=>{
      const lines=b.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      if(lines.length<6) return;
      const preg = lines[0].replace(/^\d+\.?\s*/,'');
      const A = lines.find(l=>/^A\)/i.test(l))?.replace(/^A\)\s*/i,'')||'';
      const B = lines.find(l=>/^B\)/i.test(l))?.replace(/^B\)\s*/i,'')||'';
      const C = lines.find(l=>/^C\)/i.test(l))?.replace(/^C\)\s*/i,'')||'';
      const D = lines.find(l=>/^D\)/i.test(l))?.replace(/^D\)\s*/i,'')||'';
      const corr = lines.find(l=>/^Correcta:/i.test(l))?.split(':')[1]?.trim()||'';
      const jus = lines.find(l=>/^Justificaci√≥n:/i.test(l))?.split(':')[1]?.trim()||'';
      const map={A:0,B:1,C:2,D:3}; const correcta = map[(corr||'').toUpperCase()];
      if(!preg || [A,B,C,D].some(x=>!x) || correcta==null) return;
      localList.push({ id: Date.now()+"-"+Math.random().toString(36).slice(2,8), materia, tema, pregunta: preg, opciones:[A,B,C,D], correctaindex: correcta, justificacion: jus, _updatedAt: new Date().toISOString() });
      added++;
    });
    updateEditorList();
    feedback($('e-feedback'), added? `Cargadas ${added} preguntas locales. Guard√° para subir.` : 'No se detectaron preguntas v√°lidas.', added>0);
    $('e-paste').value='';
  }

  async function guardarCloud(){
    const list = [...all, ...localList];
    const ok = await saveCloud(list);
    if(ok){
      localList = [];
      updateEditorList();
      feedback($('e-feedback'),'Guardado en la nube y sincronizado.', true);
      await fetchCloud();
    } else {
      feedback($('e-feedback'),'No se confirm√≥ guardado remoto. Puede que tu endpoint no acepte POST.', false);
    }
  }

  async function releerCloud(){ await fetchCloud(); feedback($('e-feedback'),'Le√≠do desde la nube.', true); }

  // ======= Config =======
  function loadCfg(){
    try{
      const cfg = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
      if(cfg && cfg.SCRIPT_URL){ SCRIPT_URL = cfg.SCRIPT_URL; }
    }catch{}
    $('cfg-url').value = SCRIPT_URL;
  }
  function saveCfg(){
    SCRIPT_URL = $('cfg-url').value.trim() || DEFAULT_URL;
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ SCRIPT_URL }));
  }

  async function testCfg(){
    $('cfg-feedback').textContent='Probando‚Ä¶'; $('cfg-feedback').className='mt-3 text-sm text-gray-600';
    try{
      const res = await fetch(SCRIPT_URL+"&ping=1&t="+Date.now(), {cache:'no-store'});
      const data = await res.json();
      const ok = Array.isArray(data) || (data && data.ok!==false);
      $('cfg-feedback').textContent = ok? 'Conexi√≥n OK ‚úÖ' : 'Respuesta inesperada ‚ö†Ô∏è';
      $('cfg-feedback').className = 'mt-3 text-sm ' + (ok? 'text-green-700':'text-yellow-700');
    }catch(e){ $('cfg-feedback').textContent='Error de conexi√≥n ‚ùå'; $('cfg-feedback').className='mt-3 text-sm text-red-700'; }
  }

  // =========================
  // EVENTS
  // =========================
  tabs.quiz.onclick = ()=> setTab('quiz');
  tabs.editor.onclick = ()=> setTab('editor');
  tabs.config.onclick = ()=> setTab('config');

  $('btn-refresh').onclick = fetchCloud;
  $('btn-start').onclick = ()=>{
    const m=$('sel-materia').value, t=$('sel-tema').value;
    if(!m||!t) return alert('Eleg√≠ materia y tema.');
    quizList = all.filter(q=>q.materia===m && q.tema===t);
    $('q-total').textContent = String(quizList.length);
    setTab('quiz'); $('panel-quiz'); $('quiz-box').classList.remove('hidden'); $('quiz-result').classList.add('hidden'); startQuiz();
  }
  $('sel-materia').onchange = fillTemas;
  $('btn-next').onclick = nextQuestion;
  $('btn-retry').onclick = retry;

  $('btn-add-local').onclick = addLocal;
  $('btn-clear-form').onclick = ()=>{ $('e-pregunta').value=''; $('e-opciones').value=''; $('e-correcta').value='0'; $('e-just').value=''; };
  $('btn-procesar-paste').onclick = processPaste;
  $('btn-guardar-cloud').onclick = guardarCloud;
  $('btn-releer-cloud').onclick = releerCloud;

  $('btn-save-cfg').onclick = ()=>{ saveCfg(); testCfg(); };
  $('btn-test-cfg').onclick = testCfg;

  // =========================
  // INIT
  // =========================
  (async function(){
    loadCfg();
    setTab('quiz');
    await fetchCloud();
  })();
  </script>
</body>
</html>
